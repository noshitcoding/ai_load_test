<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Load Tester</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
<style>
:root{--bg:#0f1419;--card:#1a1f2e;--card2:#151a27;--primary:#4f8ff7;--success:#22c55e;--error:#ef4444;--warn:#f59e0b;--purple:#a855f7;--cyan:#06b6d4;--text:#e2e8f0;--text2:#94a3b8;--border:#2d3748;--radius:8px;--pink:#ec4899;--lime:#84cc16}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);padding:7px 16px;font-size:13px;transition:all .15s;font-weight:500}
button:active{transform:scale(.97)}
input,textarea,select{font-family:inherit;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:7px 10px;font-size:13px;width:100%}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(79,143,247,.15)}
textarea{resize:vertical;min-height:50px}
.bp{background:var(--primary);color:#fff}.bp:hover{filter:brightness(1.15)}
.bs{background:var(--success);color:#fff}.bs:hover{filter:brightness(1.15)}
.bd{background:var(--error);color:#fff}.bd:hover{filter:brightness(1.15)}
.bo{background:transparent;border:1px solid var(--border);color:var(--text2)}.bo:hover{border-color:var(--text);color:var(--text)}
.bsm{padding:4px 10px;font-size:12px}
header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100}
header h1{font-size:18px;font-weight:600}header h1 span{color:var(--primary)}
.container{max-width:1600px;margin:0 auto;padding:20px}
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.toolbar .sep{width:1px;height:24px;background:var(--border)}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(460px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:border-color .2s,box-shadow .2s}
.card.is-run{border-color:var(--primary);box-shadow:0 0 16px rgba(79,143,247,.12)}
.card.is-done{border-color:var(--success)}
.card-head{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--card2);border-bottom:1px solid var(--border);cursor:pointer;user-select:none}
.card-dot{width:10px;height:10px;border-radius:50%;background:var(--text2);flex-shrink:0;transition:.3s}
.card-dot.running{background:var(--primary);animation:pulse 1s infinite}
.card-dot.done{background:var(--success)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.card-head .title{flex:1;font-weight:600;font-size:14px}
.card-head .elapsed{font-size:11px;color:var(--text2);font-variant-numeric:tabular-nums;min-width:48px;text-align:right}
.card-head .badge{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600;background:rgba(79,143,247,.15);color:var(--primary)}
.card-head .remove{background:none;color:var(--text2);font-size:16px;padding:2px 6px;line-height:1}.card-head .remove:hover{color:var(--error)}
.card-body{padding:14px;display:flex;flex-direction:column;gap:10px}
.card-body.collapsed{display:none}
.row{display:flex;gap:10px}.field{flex:1;display:flex;flex-direction:column;gap:3px}.field label{font-size:11px;color:var(--text2);font-weight:500}.field.full{flex-basis:100%}
.pbar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin:0}.pbar .fill{height:100%;background:var(--primary);transition:width .3s;border-radius:2px}
.card-acts{padding:8px 14px;display:flex;gap:6px;border-top:1px solid var(--border);background:var(--card2);flex-wrap:wrap;align-items:center}
.card-acts .spacer{flex:1}
.card-stats{border-top:1px solid var(--border);display:none}.card-stats.vis{display:block}
.stats-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--card2)}
.stats-tabs button{flex:1;background:none;color:var(--text2);border:none;padding:8px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid transparent;border-radius:0}
.stats-tabs button.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab-panel{display:none;padding:12px 14px}.tab-panel.active{display:block}
.sg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;text-align:center}
.sg .n{font-size:17px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1.2}
.sg .l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.sg5{grid-template-columns:repeat(5,1fr)}.sg6{grid-template-columns:repeat(6,1fr)}.sg3{grid-template-columns:repeat(3,1fr)}
.sd{margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:4px 12px;font-size:12px}
.sd4{grid-template-columns:repeat(4,1fr)}
.sd dt{color:var(--text2)}.sd dd{color:var(--text);font-weight:600;font-variant-numeric:tabular-nums;margin:0}
.mc{display:flex;align-items:flex-end;gap:1px;height:32px;margin-top:8px}
.mc .b{flex:1;min-width:2px;border-radius:1px 1px 0 0}
.mc .b.ok{background:var(--primary);opacity:.7}.mc .b.fail{background:var(--error);opacity:.9}
.tok-bars{display:flex;align-items:flex-end;gap:1px;height:28px;margin-top:6px}
.tok-bars .tb{flex:1;min-width:2px;border-radius:1px 1px 0 0;opacity:.6}
.tps-bars{display:flex;align-items:flex-end;gap:1px;height:28px;margin-top:6px}
.tps-bars .tpb{flex:1;min-width:2px;border-radius:1px 1px 0 0;background:var(--cyan);opacity:.6}
.err-list{max-height:360px;overflow-y:auto;font-size:12px}
.err-item{padding:6px 0;border-bottom:1px solid rgba(45,55,72,.3);display:flex;gap:8px;align-items:flex-start}
.err-item .et{color:var(--text2);min-width:64px;flex-shrink:0}.err-item .em{color:var(--error);white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;line-height:1.35}
.err-item .ec{font-size:10px;padding:1px 5px;border-radius:8px;font-weight:600;flex-shrink:0;margin-top:1px}
.err-item .ec.c4{background:rgba(245,158,11,.15);color:var(--warn)}
.err-item .ec.c5{background:rgba(239,68,68,.15);color:var(--error)}
.err-item .ec.cN{background:rgba(168,85,247,.15);color:var(--purple)}
.dash{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.dash-title{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:600;font-size:15px;display:flex;align-items:center;gap:12px}
.dash-body{padding:18px}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-bottom:24px}
.kpi{background:var(--bg);border-radius:var(--radius);padding:10px;text-align:center}
.kpi .v{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums}
.kpi .k{font-size:9px;color:var(--text2);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.info-i{display:inline-flex;align-items:center;justify-content:center;width:12px;height:12px;margin-left:4px;border:1px solid var(--border);border-radius:50%;font-size:9px;color:var(--text2);cursor:help;vertical-align:middle;line-height:1}
.st{font-size:13px;color:var(--text2);font-weight:600;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.hist{display:flex;flex-direction:column;gap:3px;margin-bottom:24px}
.line-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:8px;margin-bottom:24px}
.line-svg{width:100%;height:240px;display:block}
.line-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.line-item{display:flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card2);font-size:11px;color:var(--text2)}
.line-dot{width:12px;height:2px;border-radius:2px;display:inline-block}
.line-empty{font-size:12px;color:var(--text2);padding:8px}
.hr{display:flex;align-items:center;gap:8px;font-size:12px}
.hl{width:80px;text-align:right;color:var(--text2);flex-shrink:0;font-variant-numeric:tabular-nums}
.hbg{flex:1;background:var(--bg);border-radius:3px;height:20px;overflow:hidden}
.hf{height:100%;border-radius:3px;transition:width .3s}
.hc{width:50px;color:var(--text2);font-variant-numeric:tabular-nums}
.cmp{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:24px}
.cmp th{text-align:left;padding:7px;border-bottom:2px solid var(--border);color:var(--text2);font-weight:600;cursor:pointer;user-select:none;white-space:nowrap}
.cmp th:hover{color:var(--text)}.cmp th .arrow{font-size:10px;margin-left:2px}
.cmp td{padding:6px 7px;border-bottom:1px solid rgba(45,55,72,.4);font-variant-numeric:tabular-nums}
.cmp tr:hover td{background:rgba(79,143,247,.04)}
.log-ctrl{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.log-scroll{max-height:280px;overflow-y:auto}
.logt{width:100%;border-collapse:collapse;font-size:11px}
.logt th{text-align:left;padding:6px 7px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;position:sticky;top:0;background:var(--card)}
.logt td{padding:5px 7px;border-bottom:1px solid rgba(45,55,72,.3);font-variant-numeric:tabular-nums}
.s-ok{color:var(--success)}.s-err{color:var(--error)}
.ans{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2)}
.toast-box{position:fixed;bottom:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,.3);animation:slideIn .3s ease}
.toast.t-ok{border-left:3px solid var(--success)}.toast.t-err{border-left:3px solid var(--error)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@media(max-width:500px){.cards{grid-template-columns:1fr}.row{flex-direction:column}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<header>
  <h1><span>‚ö°</span> LLM Load Tester</h1>
  <span style="font-size:11px;color:var(--text2)">v3.0</span>
</header>

<div class="container">
  <div class="toolbar">
    <button class="bp" onclick="addCard()">+ Modell hinzuf√ºgen</button>
    <select id="presetSelect" style="width:auto;min-width:220px">
      <option value="">Benchmark-Preset w√§hlen‚Ä¶</option>
      <option value="latency">Latenz-Baseline (sequentiell)</option>
      <option value="throughput">Max Throughput (Dauerfeuer)</option>
      <option value="parallel_limit">Parallel-Limit finden</option>
      <option value="rpm_limit">RPM-Limit testen</option>
      <option value="key_compare">Key-Vergleich (2 Keys)</option>
    </select>
    <button class="bo" onclick="applyPresetFromUI()">‚öôÔ∏è Preset anwenden</button>
    <div class="sep"></div>
    <button class="bs" onclick="startAll()">‚ñ∂ Alle starten</button>
    <button class="bd" onclick="stopAll()">‚ñ† Alle stoppen</button>
    <button class="bo" onclick="resetAll()">‚Ü∫ Reset</button>
    <div class="sep"></div>
    <select id="profileSelect" style="width:auto;min-width:220px">
      <option value="">Benchmark-Profil‚Ä¶</option>
    </select>
    <button class="bo" onclick="saveBenchmarkProfile()">üíæ Profil speichern</button>
    <button class="bo" onclick="loadBenchmarkProfile()">üìÇ Profil laden</button>
    <button class="bo" onclick="deleteBenchmarkProfile()">üóë Profil l√∂schen</button>
    <select id="modelCfgSelect" style="width:auto;min-width:200px">
      <option value="">Modell-Konfig‚Ä¶</option>
    </select>
    <button class="bo" onclick="saveModelConfig()">üíæ Modell speichern</button>
    <button class="bo" onclick="loadModelConfig()">üìÇ Modell laden</button>
    <button class="bo" onclick="deleteModelConfig()">üóë Modell l√∂schen</button>
    <div class="sep"></div>
    <button class="bo" onclick="exportJSON()">üì• Export</button>
    <button class="bo" onclick="importJSON()">üì§ Import</button>
    <button class="bo" onclick="copyClipboard()">üìã Clipboard</button>
    <button class="bo" onclick="clearLog()">üóë Log leeren</button>
    <button class="bo" onclick="downloadEventLog()" title="Strukturiertes Event-Log als JSON herunterladen">üìä Event-Log</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
  </div>

  <div class="cards" id="cardsBox"></div>

  <div class="dash">
    <div class="dash-title">Dashboard<span style="flex:1"></span><span id="wsStatus" style="font-size:11px;cursor:help" title="WebSocket Status">WS: ‚è≥</span>&nbsp;<span style="font-size:11px;color:var(--text2)" id="dashClock"></span></div>
    <div class="dash-body">
      <div class="kpi-row" id="kpiRow"></div>
      <div class="st">Latenz-Verteilung</div>
      <div class="hist" id="histBox"></div>
      <div class="st">Completion-Token-Verteilung pro Request</div>
      <div class="hist" id="tokHistBox"></div>
      <div class="st">Tok/s pro Request Verteilung</div>
      <div class="hist" id="tpsHistBox"></div>
      <div class="st">Key-Vergleich: beantwortete Requests √ºber Zeit</div>
      <div id="keyLineBox"></div>
      <div class="st">RPS je Key</div>
      <div id="rpsKeyBox"></div>
      <div class="st">Sendeintervall je Karte (Delay-Kontrolle)</div>
      <div id="dispatchLineBox"></div>
      <div class="st">Priorisierungs-Check</div>
      <div id="prioCheckBox"></div>
      <div class="st">Modell-Vergleich <span style="font-size:10px;color:var(--text2);font-weight:400">(Klick auf Spalte zum Sortieren)</span></div>
      <div style="overflow-x:auto"><table class="cmp" id="cmpTbl"></table></div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div class="st" style="margin:0">Request Log</div>
        <div class="log-ctrl">
          <label style="font-size:11px;color:var(--text2);display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="logAuto" checked style="width:auto"> Auto-Scroll
          </label>
        </div>
      </div>
      <div class="log-scroll" id="logScroll">
        <table class="logt" id="logTbl">
          <thead><tr><th>Zeit</th><th>Modell</th><th>St</th><th>Latenz</th><th>TTFT</th><th>P-Tok</th><th>C-Tok</th><th>T-Tok</th><th>Tok/s</th><th>Prio</th><th>Batch</th><th>Antwort</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast-box" id="toastBox"></div>

<script>
var NX=0,C={},LOG=[],SORT={col:null,asc:true};
var ELOG=[]; // structured event log for analysis
var ELOG_SEQ=0; // monotonic sequence counter
var PROFILE_KEY='llm_benchmark_profiles_v1';
var MODEL_CFG_KEY='llm_model_configs_v1';
var COLORS=['#4f8ff7','#22c55e','#f59e0b','#ef4444','#a855f7','#06b6d4','#ec4899','#84cc16','#fb923c','#14b8a6'];
function $$(id){return document.getElementById(id)}
function fms(v){if(v===null||v===undefined||isNaN(v))return'‚Äì';return v<1000?Math.round(v)+'ms':(v/1000).toFixed(2)+'s'}
function fn(v,d){return(v===null||v===undefined||isNaN(v))?'‚Äì':(d!==undefined?v.toFixed(d):v)}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function normalizeApiUrl(raw){
  var input=(raw||'').trim();
  var url=input.replace(/\/+$/,'');
  if(!url)return'';
  else if(!/^https?:\/\//i.test(url))url='http://'+url.replace(/^\/+/, '');
  return url;
}
function errMsg(e){
  if(!e)return'Error';
  if(typeof e==='string')return e;
  return e.message||String(e)||'Error';
}
function shouldUseInsecureProxy(cfg){
  return cfg&&cfg.sslVerify===false&&/^https:\/\//i.test(cfg.url||'');
}
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WebSocket Proxy Transport ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
var WS={sock:null,cbs:{},seq:0,reconnTimer:null,ready:false,connectPromise:null};
function wsUpdateStatus(){
  var el=document.getElementById('wsStatus');
  if(!el)return;
  if(WS.ready){el.textContent='WS: \u2705';el.title='WebSocket verbunden'}
  else{el.textContent='WS: \u274c';el.title='WebSocket getrennt'}
}
function wsConnect(){
  if(WS.sock&&(WS.sock.readyState===0||WS.sock.readyState===1))return WS.connectPromise;
  var proto=location.protocol==='https:'?'wss:':'ws:';
  var url=proto+'//'+location.host+'/ws';
  console.log('[WS] connecting to',url);
  WS.sock=new WebSocket(url);
  WS.connectPromise=new Promise(function(resolve){
    WS.sock.onopen=function(){
      WS.ready=true;
      console.log('[WS] connected, readyState='+WS.sock.readyState);
      wsUpdateStatus();
      resolve(true);
    };
  });
  WS.sock.onclose=function(ev){
    WS.ready=false;
    console.log('[WS] closed code='+ev.code+' reason='+ev.reason);
    wsUpdateStatus();
    clearTimeout(WS.reconnTimer);
    WS.reconnTimer=setTimeout(wsConnect,2000);
  };
  WS.sock.onerror=function(ev){
    WS.ready=false;
    console.error('[WS] error',ev);
    wsUpdateStatus();
  };
  WS.sock.onmessage=function(ev){
    try{var msg=JSON.parse(ev.data)}catch(e){console.error('[WS] bad JSON',ev.data);return}
    var id=msg.id,cb=WS.cbs[id];
    if(!cb){console.warn('[WS] no callback for id='+id);return}
    if(msg.type==='response'){
      delete WS.cbs[id];
      cb.resolve(msg);
    }else if(msg.type==='stream_start'){
      cb.status=msg.status;cb.headers=msg.headers;cb.chunks=[];
      if(cb.onStart)cb.onStart(msg);
    }else if(msg.type==='stream_chunk'){
      if(cb.chunks)cb.chunks.push(msg.data);
      if(cb.onChunk)cb.onChunk(msg.data);
    }else if(msg.type==='stream_end'){
      delete WS.cbs[id];
      cb.resolve({status:cb.status,headers:cb.headers||{},chunks:cb.chunks||[]});
    }else if(msg.type==='error'){
      delete WS.cbs[id];
      cb.reject(new Error(msg.error));
    }
  };
  return WS.connectPromise;
}
wsConnect();

function wsEnsureReady(){
  if(WS.ready&&WS.sock&&WS.sock.readyState===1)return Promise.resolve();
  console.log('[WS] not ready, reconnecting...');
  WS.connectPromise=null;
  if(WS.sock){try{WS.sock.close()}catch(e){}}
  WS.sock=null;
  return wsConnect();
}

function wsFetch(url,method,headers,body,stream){
  return wsEnsureReady().then(function(){
    return new Promise(function(resolve,reject){
      if(!WS.ready||!WS.sock||WS.sock.readyState!==1){
        return reject(new Error('WebSocket nicht verbunden (state='+(WS.sock?WS.sock.readyState:'null')+')'));
      }
      var id=String(++WS.seq);
      WS.cbs[id]={resolve:resolve,reject:reject,chunks:[],status:0,headers:{}};
      var payload=JSON.stringify({id:id,url:url,method:method||'GET',headers:headers||{},body:body||null,stream:!!stream});
      try{
        WS.sock.send(payload);
      }catch(e){
        delete WS.cbs[id];
        reject(new Error('WS send failed: '+e.message));
      }
    });
  });
}

function apiFetch(cfg,path,opts){
  var target=(cfg.url||'')+path;
  var o=opts?Object.assign({},opts):{};
  // Immer WebSocket nutzen f√ºr API-Calls an LiteLLM
  if(target.indexOf('/chat/completions')!==-1||target.indexOf('/models')!==-1){
    var hdrs=o.headers||{};
    return wsFetch(target,o.method||'GET',hdrs,o.body,false).then(function(msg){
      // Fake-Response-Objekt bauen (kompatibel mit bisherigem Code)
      var status=msg.status||200;
      var respHeaders=msg.headers||{};
      var bodyText=msg.body||'';
      return {
        ok:status>=200&&status<300,
        status:status,
        headers:{get:function(k){
          var lk=k.toLowerCase();
          for(var h in respHeaders){if(h.toLowerCase()===lk)return respHeaders[h]}
          return null;
        }},
        text:function(){return Promise.resolve(bodyText)},
        json:function(){return Promise.resolve(JSON.parse(bodyText))},
        body:null
      };
    });
  }
  // Fallback: normaler fetch f√ºr /data/ etc.
  if(shouldUseInsecureProxy(cfg)){
    var h=Object.assign({},o.headers||{});
    h['X-Target-Url']=target;
    o.headers=h;
    return fetch('/proxy-insecure',o);
  }
  return fetch(target,o);
}
function keyLabel(key){
  var k=(key||'').trim();
  if(!k)return'kein-key';
  if(k.length<=10)return k;
  return k.slice(0,4)+'‚Ä¶'+k.slice(-4);
}
function infoText(label){
  var l=(label||'').toLowerCase().trim();
  var m={
    'gesendet':'Gesamtzahl aller abgeschickten HTTP-Requests seit Start. Enth√§lt erfolgreiche + fehlgeschlagene + noch laufende.',
    'ok':'Anzahl Requests, die mit HTTP 200 und g√ºltigem JSON beantwortet wurden. Nur diese flie√üen in Latenz-/Token-Statistiken ein.',
    'fehler':'Requests, die fehlgeschlagen sind: HTTP 4xx (z.B. 429 Rate-Limit), 5xx (Server-Fehler), Netzwerk-Fehler (DNS, Connection refused) oder Timeout.',
    'aktiv':'Requests, die gerade in-flight sind ‚Äî abgeschickt, aber noch keine Antwort erhalten. Bei Streaming z√§hlt der Request bis zum letzten Chunk.',
    'rps':'Gemessene Requests pro Sekunde = (OK + Fehler) √∑ Laufzeit in Sekunden. Zeigt den tats√§chlichen Durchsatz, nicht den konfigurierten.',
    'req/s':'Gemessene Requests pro Sekunde = (OK + Fehler) √∑ Laufzeit in Sekunden. Zeigt den tats√§chlichen Durchsatz, nicht den konfigurierten.',
    'c-tok/s':'Completion-Tokens pro Sekunde √ºber gesamte Laufzeit = Œ£ Completion-Tokens √∑ Laufzeit. Misst die LLM-Generierungsleistung.',
    't-tok/s':'Gesamte Tokens (Prompt + Completion) pro Sekunde √ºber die Laufzeit. Zeigt die volle I/O-Last am Modell.',
    'p-tok/s':'Prompt-Tokens pro Sekunde √ºber die Laufzeit. Bei kurzen Prompts niedrig, bei langen Kontexten ein Bottleneck-Indikator.',
    'delay soll':'Konfiguriertes Sende-Intervall in Millisekunden. Alle <Delay> ms wird eine neue Batch von Requests abgefeuert. 0 = sofort n√§chste Batch nach Abfeuern.',
    'Œ¥send √∏':'Tats√§chlicher Durchschnitt der Zeitabst√§nde zwischen aufeinanderfolgenden Request-Dispatches (ms). Sollte nahe am konfigurierten Delay liegen ‚Äî weicht es ab, ist der Browser/Netzwerk √ºberlastet.',
    'Œ¥send p50':'Median (50. Perzentil) der Zeitabst√§nde zwischen Dispatches. Robuster als der Durchschnitt, da Ausrei√üer ignoriert werden.',
    'requests':'Gesamtzahl aller abgeschickten Requests √ºber alle Karten im Dashboard.',
    'erfolgsrate':'Anteil erfolgreicher Requests (HTTP 200 mit g√ºltigem JSON) in Prozent. 100% = keine Fehler. Werte unter 95% deuten auf Rate-Limiting oder Serverlast hin.',
    'fehlerrate':'Anteil fehlerhafter Requests in Prozent = 100% ‚àí Erfolgsrate. Hohe Werte zeigen Rate-Limiting (429), Server√ºberlastung (503) oder Netzwerkprobleme.',
    'rpm':'Requests pro Minute (RPM): Vom LiteLLM-Server gemeldetes Limit √ºber den Response-Header x-litellm-key-rpm-limit. Wert 0 = Header nicht empfangen.',
    'rpm limit':'Requests pro Minute: Vom Server pro API-Key konfiguriertes Maximum (Header: x-litellm-key-rpm-limit). Wird erst bei ausreichend vielen Requests sp√ºrbar.',
    'max parallel':'Maximale gleichzeitige Requests, die der Server f√ºr diesen API-Key erlaubt (Header: x-ratelimit-api_key-limit-max_parallel_requests). Wird in-flight √ºberschritten, antwortet der Server mit 429.',
    'max‚à•':'Maximale gleichzeitige Requests f√ºr diesen Key laut Server-Header. Wenn In-Flight diesen Wert √ºbersteigt ‚Üí 429 Rate-Limit-Fehler.',
    '‚à• frei':'Verbleibende parallele Slots laut letztem Server-Response (Header: x-ratelimit-remaining-max_parallel_requests). Wert 0 = n√§chster Request bekommt 429.',
    '‚à• √ºbrig':'Verbleibende parallele Slots laut letztem Server-Response. Sinkt auf 0, wenn alle erlaubten Parallel-Requests belegt sind.',
    'in-flight':'Aktuell fliegende Requests: abgeschickt, aber noch ohne Antwort. Wichtig f√ºr Laststeuerung ‚Äî √ºbersteigt dieser Wert Max‚à•, gibt es 429-Fehler.',
    'header-rps':'Vom Server √ºber Response-Header gemeldete RPS-Begrenzung (z.B. x-ratelimit-limit-requests).',
    'avg':'Arithmetisches Mittel der Latenz aller erfolgreichen Requests. Empfindlich f√ºr Ausrei√üer ‚Äî P50 ist oft aussagekr√§ftiger.',
    'p50':'Median-Latenz: 50% der Requests sind schneller, 50% langsamer. Robusteste Latenz-Kennzahl.',
    'p95':'95. Perzentil der Latenz: Nur 5% der Requests sind langsamer. Zeigt die "schlechte" User-Experience.',
    'p99':'99. Perzentil der Latenz: Nur 1% der Requests sind langsamer. Zeigt Worst-Case-Verhalten unter Last.',
    'min':'Schnellste gemessene Antwortzeit. Zeigt die theoretisch beste Latenz des Modells ohne Warteschlange.',
    'max':'Langsamste gemessene Antwortzeit. Oft durch queuing oder Rate-Limiting verursacht.',
    'stddev':'Standardabweichung der Latenz. Hohe Werte = ungleichm√§√üige Antwortzeiten, niedrige Werte = stabil.',
    'erfolg':'Erfolgsrate in Prozent. Werte < 100% deuten auf Rate-Limiting, Timeout oder Serverfehler hin.',
    'dauer':'Gesamte bisherige Laufzeit des Tests in Sekunden.',
    'gesamt tok':'Summe aller Prompt- und Completion-Tokens. Zeigt die gesamte I/O-Last am Modell.',
    'prompt tok':'Summe aller Prompt-Tokens √ºber alle Requests. Beeinflusst die Antwortzeit (mehr Context = langsamer).',
    'compl tok':'Summe aller Completion-Tokens. Hauptindikator f√ºr die generierte Textmenge.',
    '√∏ c-tok/req':'Durchschnittliche Completion-Tokens pro Request. H√§ngt von max_tokens und Prompt ab.',
    '√∏ tok/s/req':'Durchschnittliche Generierungsgeschwindigkeit pro einzelnem Request (Completion-Tokens √∑ Latenz).',
    '√∏ p-tok/req':'Durchschnittliche Prompt-Tokens pro Request.',
    '√∏ t-tok/req':'Durchschnittliche Gesamt-Tokens pro Request (Prompt + Completion).',
    'i/o ratio':'Verh√§ltnis Input/Output = Prompt-Tokens √∑ Completion-Tokens. Hoch = viel Kontext, wenig Antwort.',
    'c-tok min':'Minimale Completion-Tokens in einem einzelnen Response.',
    'c-tok max':'Maximale Completion-Tokens in einem einzelnen Response.',
    'c-tok p50':'Median der Completion-Tokens pro Response.',
    'c-tok p95':'95. Perzentil der Completion-Tokens ‚Äî zeigt die l√§ngsten Antworten.',
    '√∏ tok/s/req':'Mittlere Token-Generierungsrate pro Request in Tok/s.',
    'tok/s p50':'Median der Tok/s-Werte √ºber alle Requests.',
    'tok/s p95':'95. Perzentil der Tok/s ‚Äî obere Leistungsgrenze der Generierung.',
    'tok/s peak':'H√∂chster gemessener Tok/s-Wert in einem einzelnen Request.',
    'peak tok/s':'H√∂chster gemessener Tok/s-Wert √ºber alle Requests aller Karten.',
    '√∏ ttft':'Durchschnittliche Time-to-First-Token: Zeit vom Absenden bis zum Empfang des ersten Tokens (nur bei Streaming).',
    'ttft p50':'Median der Time-to-First-Token ‚Äî zeigt die typische Wartezeit auf das erste Token.',
    'ttft p95':'95. Perzentil der TTFT ‚Äî zeigt Worst-Case-Wartezeit auf erstes Token.',
    'ttft min':'Schnellste TTFT ‚Äî bestes Szenario f√ºr interaktive Nutzung.',
    'ttft max':'Langsamste TTFT ‚Äî zeigt maximale Wartezeit.',
    'total req':'Gesamtzahl Requests in dieser Karte.',
    'fails':'Fehlgeschlagene Requests (4xx + 5xx + Netzwerk + Timeout).',
    'elapsed':'Bisherige Laufzeit dieser Karte in Sekunden.',
    'modelle':'Anzahl aktiver Modell-Karten im Dashboard.',
    'ok/s vorteil':'Prozentuale Verbesserung der OK-Rate/s zwischen h√∂chster und niedrigster Priorit√§t.',
    '√∏ latenz reduktion':'Prozentuale Latenz-Verbesserung der h√∂chsten vs niedrigsten Priorit√§t.',
    'p50 latenz reduktion':'Prozentuale P50-Latenz-Verbesserung der h√∂chsten vs niedrigsten Priorit√§t.',
    '4xx':'Anzahl Client-Fehler (HTTP 400-499). H√§ufigster Grund: 429 = Rate-Limit √ºberschritten. Auch 401 (ung√ºltiger Key) oder 422 (ung√ºltige Parameter).',
    '5xx':'Anzahl Server-Fehler (HTTP 500-599). Typisch: 502 Bad Gateway, 503 Service Unavailable (Modell √ºberlastet).',
    'netzwerk':'Fehler ohne HTTP-Status: DNS-Aufl√∂sung fehlgeschlagen, Connection refused, TLS-Fehler, CORS blockiert.',
    'timeout':'Requests, die das Browser-Timeout erreicht haben, ohne eine Antwort zu erhalten.'
  };
  return m[l]||'Kennzahl f√ºr Last, Geschwindigkeit oder Stabilit√§t dieses Tests.';
}
function infoIcon(label){
  return'<span class="info-i" title="'+esc(infoText(label))+'">i</span>';
}
function ensureInfoIcons(){
  var nodes=document.querySelectorAll('.k,.l,dt');
  for(var i=0;i<nodes.length;i++){
    var n=nodes[i];
    if(n.dataset.infoDone==='1')continue;
    var raw=(n.textContent||'').trim();
    if(!raw)continue;
    n.insertAdjacentHTML('beforeend',infoIcon(raw));
    n.dataset.infoDone='1';
  }
}

var BENCHMARK_PRESETS={
  latency:function(base){
    // Sequentiell, 1 Req alle 500ms, max 1 parallel ‚Üí saubere Baseline-Latenzen ohne Queuing
    return [{
      url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
      sysPrompt:'',prompt:'Antworte kurz und pr√§zise in einem Satz.',
      batch:1,delay:500,total:60,conc:1,maxTok:10,temp:0.2,priority:0,stream:false
    }];
  },
  throughput:function(base){
    // Dauerfeuer: Batch 10, kein Delay, 40 parallel (typisches max_parallel_requests Limit)
    return [{
      url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
      sysPrompt:'',prompt:'Erzeuge eine detaillierte Antwort mit mehreren Punkten.',
      batch:10,delay:100,total:500,conc:40,maxTok:60,temp:0.7,priority:0,stream:true
    }];
  },
  parallel_limit:function(base){
    // 3 Karten mit steigender Parallelit√§t ‚Üí zeigt wo max_parallel_requests greift (429 Fehler)
    return [
      {
        url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:20,delay:100,total:200,conc:20,maxTok:10,temp:0.1,priority:0,stream:false
      },
      {
        url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:40,delay:100,total:200,conc:40,maxTok:10,temp:0.1,priority:0,stream:false
      },
      {
        url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:80,delay:100,total:200,conc:80,maxTok:10,temp:0.1,priority:0,stream:false
      }
    ];
  },
  rpm_limit:function(base){
    // Karte 1: 2 Req/s √ó 60s = 120 RPM ‚Üí unter typischem Limit
    // Karte 2: 5 Req/s √ó 60s = 300 RPM ‚Üí √ºber RPM-60 Limit
    return [
      {
        url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:1,delay:500,total:120,conc:5,maxTok:5,temp:0.1,priority:0,stream:false
      },
      {
        url:base.url,key:base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:5,delay:1000,total:400,conc:10,maxTok:5,temp:0.1,priority:0,stream:false
      }
    ];
  },
  key_compare:function(base){
    // Gleiche Last auf zwei Keys ‚Üí zeigt Unterschied bei max_parallel / RPM Limits
    return [
      {
        url:base.url,key:base.key1||base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:10,delay:200,total:300,conc:30,maxTok:10,temp:0.1,priority:0,stream:false
      },
      {
        url:base.url,key:base.key2||base.key,model:base.model||'Qwen/Qwen3-8B',
        sysPrompt:'',prompt:'Hi',
        batch:10,delay:200,total:300,conc:30,maxTok:10,temp:0.1,priority:0,stream:false
      }
    ];
  }
};

function toast(msg,type){
  var t=document.createElement('div');t.className='toast t-'+(type||'ok');t.textContent=msg;
  $$('toastBox').appendChild(t);
  setTimeout(function(){t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(function(){t.remove()},300)},4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCard(cfg){
  var id=++NX,color=COLORS[(id-1)%COLORS.length],p=cfg||{};
  var div=document.createElement('div');div.className='card';div.id='c'+id;
  div.innerHTML=
  '<div class="card-head" data-toggle="'+id+'" style="border-left:3px solid '+color+'">'+
    '<div class="card-dot" id="dot'+id+'"></div>'+
    '<span class="title" id="tit'+id+'">'+(p.model?esc(p.model):'Neues Modell')+'</span>'+
    '<span class="elapsed" id="clk'+id+'"></span>'+
    '<span class="badge" id="bdg'+id+'" style="display:none"></span>'+
    '<button class="bo bsm" data-dup="'+id+'" style="padding:2px 8px" title="Duplizieren">‚ßâ</button>'+
    '<button class="remove" data-remove="'+id+'" title="Entfernen">‚úï</button>'+
  '</div>'+
  '<div class="pbar"><div class="fill" id="pb'+id+'" style="width:0"></div></div>'+
  '<div class="card-body" id="body'+id+'">'+
    '<div class="row">'+
      '<div class="field" style="flex:2"><label>API Base URL</label><input id="url'+id+'" value="'+(p.url||'http://localhost:4000/v1')+'" placeholder="http://‚Ä¶"></div>'+
      '<div class="field"><label>API Key</label><input type="password" id="key'+id+'" value="'+(p.key||'sk-1234')+'" placeholder="sk-‚Ä¶"></div>'+
      '<div class="field" style="flex:0;align-self:flex-end"><button class="bo bsm" data-test="'+id+'" style="white-space:nowrap">Test</button></div>'+
    '</div>'+
    '<div class="row"><div class="field full">'+
      '<label>Modell</label><input list="mdl'+id+'" id="m'+id+'" value="'+(p.model||'')+'" placeholder="z.B. qwen3:4b">'+
      '<datalist id="mdl'+id+'"></datalist>'+
    '</div></div>'+
    '<div class="row"><div class="field full">'+
      '<label>System Prompt <span style="color:var(--text2);font-weight:400">(optional)</span></label>'+
      '<textarea id="sp'+id+'" rows="2" placeholder="Du bist ein hilfreicher Assistent‚Ä¶">'+(p.sysPrompt||'')+'</textarea>'+
    '</div></div>'+
    '<div class="row"><div class="field full">'+
      '<label>User Prompt</label>'+
      '<textarea id="pr'+id+'" rows="2">'+(p.prompt||'What is the capital of France? Answer in one sentence.')+'</textarea>'+
    '</div></div>'+
    '<div class="row">'+
      '<div class="field"><label>Batch Size</label><input type="number" id="bs'+id+'" min="1" max="100" value="'+(p.batch||1)+'" title="Requests pro Tick"></div>'+
      '<div class="field"><label>Sendeintervall (ms)</label><input type="number" id="dy'+id+'" min="0" max="300000" value="'+(p.delay||0)+'"></div>'+
      '<div class="field"><label>Requests (0=‚àû)</label><input type="number" id="tr'+id+'" min="0" max="999999" value="'+(p.total!==undefined?p.total:50)+'"></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="field"><label>Max Parallel (0=‚àû)</label><input type="number" id="co'+id+'" min="0" max="10000" value="'+(p.conc!==undefined?p.conc:0)+'" title="Maximale gleichzeitige In-Flight-Requests. 0 = unbegrenzt. Wird dieser Wert erreicht, wartet der Loader bis ein Request fertig ist."></div>'+
      '<div class="field"><label>Max Tokens</label><input type="number" id="mt'+id+'" min="1" max="32768" value="'+(p.maxTok||60)+'"></div>'+
      '<div class="field"><label>Temperatur</label><input type="number" id="tp'+id+'" min="0" max="2" step="0.1" value="'+(p.temp!==undefined?p.temp:0.7)+'"></div>'+
      '<div class="field"><label>Priorit√§t (kleiner = h√∂her)</label><input type="number" id="pri'+id+'" min="0" max="100000" value="'+(p.priority!==undefined?p.priority:0)+'" title="0=h√∂chste"></div>'+
      '<div class="field"><label>Stream</label>'+
        '<select id="st'+id+'"><option value="0"'+(p.stream?'':' selected')+'>Nein</option><option value="1"'+(p.stream?' selected':'')+'>Ja</option></select>'+
      '</div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="field"><label>SSL Verify</label>'+
        '<select id="sv'+id+'"><option value="0"'+(p.sslVerify===true?'':' selected')+'>False</option><option value="1"'+(p.sslVerify===true?' selected':'')+'>True</option></select>'+
      '</div>'+
      '<div class="field"><label>API Endpoint</label><input value="/chat/completions" readonly title="LiteLLM Standard-Endpunkt"></div>'+
    '</div>'+
  '</div>'+
  '<div class="card-acts">'+
    '<button class="bs bsm" data-start="'+id+'">‚ñ∂ Start</button>'+
    '<button class="bd bsm" data-stop="'+id+'">‚ñ† Stop</button>'+
    '<button class="bo bsm" data-res="'+id+'">‚Ü∫ Reset</button>'+
    '<button class="bo bsm" data-toggle="'+id+'" title="Einstellungen w√§hrend des Tests √§ndern">‚úèÔ∏è Edit</button>'+
    '<span class="spacer"></span>'+
    '<button class="bo bsm" data-load="'+id+'">Modelle laden</button>'+
  '</div>'+
  '<div class="card-stats" id="cs'+id+'">'+
    '<div class="stats-tabs" id="tabs'+id+'">'+
      '<button class="active" data-tab="ov'+id+'">√úbersicht</button>'+
      '<button data-tab="tok'+id+'">Tokens</button>'+
      '<button data-tab="thr'+id+'">Durchsatz</button>'+
      '<button data-tab="err'+id+'">Fehler</button>'+
    '</div>'+
    '<div class="tab-panel active" id="ov'+id+'">'+
      '<div class="sg">'+
        '<div><div class="n" id="xS'+id+'">0</div><div class="l">Gesendet</div></div>'+
        '<div><div class="n" style="color:var(--success)" id="xO'+id+'">0</div><div class="l">OK</div></div>'+
        '<div><div class="n" style="color:var(--error)" id="xF'+id+'">0</div><div class="l">Fehler</div></div>'+
        '<div><div class="n" style="color:var(--primary)" id="xA'+id+'">0</div><div class="l">Aktiv</div></div>'+
      '</div>'+
      '<dl class="sd sd4" id="xD'+id+'"></dl>'+
      '<div class="mc" id="xC'+id+'"></div>'+
    '</div>'+
    '<div class="tab-panel" id="tok'+id+'">'+
      '<div class="sg sg6">'+
        '<div><div class="n" style="color:var(--warn)" id="tPT'+id+'">0</div><div class="l">Prompt Tok</div></div>'+
        '<div><div class="n" style="color:var(--success)" id="tCT'+id+'">0</div><div class="l">Compl Tok</div></div>'+
        '<div><div class="n" id="tTT'+id+'">0</div><div class="l">Gesamt Tok</div></div>'+
        '<div><div class="n" style="color:var(--cyan)" id="tCTps'+id+'">0</div><div class="l">C-Tok/s</div></div>'+
        '<div><div class="n" style="color:var(--purple)" id="tTTps'+id+'">0</div><div class="l">T-Tok/s</div></div>'+
        '<div><div class="n" style="color:var(--pink)" id="tTtf'+id+'">‚Äì</div><div class="l">√ò TTFT</div></div>'+
      '</div>'+
      '<dl class="sd sd4" id="tD'+id+'"></dl>'+
      '<div style="font-size:10px;color:var(--text2);margin-top:8px">Completion Tokens/Req</div>'+
      '<div class="tok-bars" id="tB'+id+'"></div>'+
      '<div style="font-size:10px;color:var(--text2);margin-top:8px">Tok/s pro Request</div>'+
      '<div class="tps-bars" id="tpB'+id+'"></div>'+
    '</div>'+
    '<div class="tab-panel" id="thr'+id+'">'+
      '<div class="sg sg3">'+
        '<div><div class="n" id="thrRps'+id+'">0</div><div class="l">RPS</div></div>'+
        '<div><div class="n" style="color:var(--cyan)" id="thrTps'+id+'">0</div><div class="l">Tok/s (ges.)</div></div>'+
        '<div><div class="n" style="color:var(--lime)" id="thrPeak'+id+'">0</div><div class="l">Peak Tok/s</div></div>'+
      '</div>'+
      '<dl class="sd sd4" id="thrD'+id+'"></dl>'+
      '<div style="font-size:10px;color:var(--text2);margin-top:8px">RPS √ºber Zeit (5s Fenster)</div>'+
      '<div class="mc" id="thrC'+id+'"></div>'+
    '</div>'+
    '<div class="tab-panel" id="err'+id+'">'+
      '<div class="sg" style="margin-bottom:8px">'+
        '<div><div class="n" style="color:var(--warn)" id="e4'+id+'">0</div><div class="l">4xx</div></div>'+
        '<div><div class="n" style="color:var(--error)" id="e5'+id+'">0</div><div class="l">5xx</div></div>'+
        '<div><div class="n" style="color:var(--purple)" id="eN'+id+'">0</div><div class="l">Netzwerk</div></div>'+
        '<div><div class="n" style="color:var(--text2)" id="eT'+id+'">0</div><div class="l">Timeout</div></div>'+
      '</div>'+
      '<div class="err-list" id="eL'+id+'"></div>'+
    '</div>'+
  '</div>';

  $$('cardsBox').appendChild(div);
  var mi=$$('m'+id);mi.addEventListener('input',function(){$$('tit'+id).textContent=mi.value||'Neues Modell'});
  div.addEventListener('click',function(e){
    var t=e.target,d=t.dataset;
    if(d.start)doStart(+d.start);if(d.stop)doStop(+d.stop);if(d.res)doReset(+d.res);
    if(d.remove)removeCard(+d.remove);if(d.dup)dupCard(+d.dup);
    if(d.test)testCard(+d.test);if(d.load)loadModels(+d.load);
    if(d.toggle){$$('body'+d.toggle).classList.toggle('collapsed')}
    if(d.tab){
      var btns=t.parentElement.querySelectorAll('button');
      for(var i=0;i<btns.length;i++){btns[i].classList.remove('active');$$(btns[i].dataset.tab).classList.remove('active')}
      t.classList.add('active');$$(d.tab).classList.add('active');
    }
  });
  C[id]={el:div,color:color,run:false,
    sent:0,ok:0,fail:0,active:0,
    lats:[],ttfbs:[],tl:[],
    promptTok:0,compTok:0,totalTok:0,
    promptTokPerReq:[],compTokPerReq:[],totalTokPerReq:[],
    tpsPerReq:[],peakTps:0,
    throughputBins:[],
    errs:[],e4:0,e5:0,eN:0,eT:0,
    t0:null,tEnd:null,model:'',aborts:[],
    keyLabel:keyLabel(p.key||''),priority:(p.priority!==undefined?p.priority:0),delayCfg:(p.delay||0),dispatchTs:[],serverRpsLimit:0,
    serverRpmLimit:0,serverMaxParallel:0,serverParallelRemaining:0,
    loopTimer:null,nextSendAt:0};
  return id;
}

function removeCard(id){doStop(id);var c=C[id];if(c&&c.el)c.el.remove();delete C[id]}
function dupCard(id){addCard(getConf(id));toast('Karte dupliziert')}

function getConf(id){
  var normUrl=normalizeApiUrl($$('url'+id).value||'');
  $$('url'+id).value=normUrl;
  return{
    url:normUrl,
    key:$$('key'+id).value||'',
    model:$$('m'+id).value,
    sysPrompt:$$('sp'+id).value,
    prompt:$$('pr'+id).value,
    batch:parseInt($$('bs'+id).value)||1,
    delay:parseInt($$('dy'+id).value)||0,
    total:parseInt($$('tr'+id).value)||0,
    conc:parseInt($$('co'+id).value)||0,
    maxTok:parseInt($$('mt'+id).value)||60,
    temp:parseFloat($$('tp'+id).value),
    priority:parseInt($$('pri'+id).value)||0,
    stream:$$('st'+id).value==='1',
    sslVerify:$$('sv'+id).value==='1'
  };
}
// Re-read mutable fields from inputs during a running test (live-edit support)
function getLiveConf(id,base){
  var el=$$('bs'+id);if(!el)return base; // card removed
  return Object.assign({},base,{
    batch:parseInt($$('bs'+id).value)||1,
    delay:parseInt($$('dy'+id).value)||0,
    total:parseInt($$('tr'+id).value)||0,
    conc:parseInt($$('co'+id).value)||0,
    maxTok:parseInt($$('mt'+id).value)||60,
    temp:parseFloat($$('tp'+id).value),
    priority:parseInt($$('pri'+id).value)||0,
    stream:$$('st'+id).value==='1',
    prompt:$$('pr'+id).value,
    sysPrompt:$$('sp'+id).value,
  });
}

function testCard(id){
  var cfg=getConf(id),tit=$$('tit'+id),prev=tit.textContent;tit.textContent='‚è≥ Teste‚Ä¶';
  apiFetch(cfg,'/models',{headers:{'Authorization':'Bearer '+cfg.key}})
    .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);tit.textContent='‚úì Verbunden';setTimeout(function(){tit.textContent=cfg.model||prev},2000)})
    .catch(function(e){
      var m=errMsg(e);
      tit.textContent='‚úó '+m;
      toast('Verbindungstest fehlgeschlagen: '+m.slice(0,140),'err');
      setTimeout(function(){tit.textContent=cfg.model||prev},3000)
    });
}
function loadModels(id){
  var cfg=getConf(id),tit=$$('tit'+id);
  apiFetch(cfg,'/models',{headers:{'Authorization':'Bearer '+cfg.key}})
    .then(function(r){return r.json()}).then(function(d){
      var ms=(d.data||[]).map(function(m){return m.id}).filter(function(x){return x.indexOf('*')===-1});
      $$('mdl'+id).innerHTML=ms.map(function(m){return'<option value="'+esc(m)+'">'}).join('');
      tit.textContent=ms.length+' Modelle';setTimeout(function(){tit.textContent=cfg.model||'Neues Modell'},2000);
    }).catch(function(e){
      var m=errMsg(e);
      tit.textContent='‚úó '+m;
      toast('Modelle laden fehlgeschlagen: '+m.slice(0,140),'err');
      setTimeout(function(){tit.textContent=cfg.model||'Neues Modell'},3000)
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START / STOP / RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doStart(id){
  var c=C[id];if(!c||c.run)return;
  var cfg=getConf(id);if(!cfg.model){alert('Bitte ein Modell eingeben!');return}
  if(!cfg.url){toast('API Base URL fehlt','err');return}
  c.run=true;c.model=cfg.model;c.t0=Date.now();c.tEnd=null;
  c.keyLabel=keyLabel(cfg.key);c.priority=cfg.priority;c.delayCfg=cfg.delay;c.dispatchTs=[];c.serverRpsLimit=0;
  c.serverRpmLimit=0;c.serverMaxParallel=0;c.serverParallelRemaining=0;
  c.loopTimer=null;c.nextSendAt=0;
  // Event-Log: test_start
  elog('test_start',id,{
    config:{
      url:cfg.url,key_label:keyLabel(cfg.key),model:cfg.model,
      batch:cfg.batch,delay:cfg.delay,total:cfg.total,conc:cfg.conc,
      maxTok:cfg.maxTok,temp:cfg.temp,priority:cfg.priority,
      stream:cfg.stream,sslVerify:cfg.sslVerify,
      sysPrompt:cfg.sysPrompt?cfg.sysPrompt.slice(0,200):'',
      prompt:cfg.prompt?cfg.prompt.slice(0,200):''
    }
  });
  $$('tit'+id).textContent=cfg.model;
  $$('cs'+id).classList.add('vis');$$('body'+id).classList.add('collapsed');
  loop(id,cfg);
}
function doStop(id){var c=C[id];if(!c)return;
  var wasRunning=c.run;
  c.run=false;if(c.loopTimer){clearTimeout(c.loopTimer);c.loopTimer=null}for(var i=0;i<c.aborts.length;i++)c.aborts[i].abort();c.aborts=[];
  if(wasRunning){
    elog('test_stop',id,{reason:'manual',sent:c.sent,ok:c.ok,fail:c.fail,active:c.active,
      elapsed_s:c.t0?((Date.now()-c.t0)/1000):0,
      serverRpmLimit:c.serverRpmLimit,serverMaxParallel:c.serverMaxParallel});
  }
}
function doReset(id){
  doStop(id);var c=C[id];if(!c)return;
  c.sent=0;c.ok=0;c.fail=0;c.active=0;
  c.lats=[];c.ttfbs=[];c.tl=[];
  c.promptTok=0;c.compTok=0;c.totalTok=0;
  c.promptTokPerReq=[];c.compTokPerReq=[];c.totalTokPerReq=[];
  c.tpsPerReq=[];c.peakTps=0;c.throughputBins=[];
  c.errs=[];c.e4=0;c.e5=0;c.eN=0;c.eT=0;c.t0=null;c.tEnd=null;
  c.dispatchTs=[];c.serverRpsLimit=0;
  c.serverRpmLimit=0;c.serverMaxParallel=0;c.serverParallelRemaining=0;
  c.loopTimer=null;c.nextSendAt=0;
  $$('pb'+id).style.width='0';
  $$('cs'+id).classList.remove('vis');$$('body'+id).classList.remove('collapsed');
}
function startAll(){for(var id in C)doStart(+id)}
function stopAll(){for(var id in C)doStop(+id)}
function resetAll(){for(var id in C)doReset(+id);LOG=[];ELOG=[];ELOG_SEQ=0;toast('Alles zur√ºckgesetzt')}
function clearLog(){LOG=[];toast('Log geleert')}

function getFirstCardBase(){
  var ids=Object.keys(C);
  if(ids.length===0)return{url:'http://localhost:4000/v1',key:'sk-1234',model:'gpt-oss:20b'};
  var cfg=getConf(+ids[0]);
  var key2=ids.length>1?getConf(+ids[1]).key:cfg.key;
  return{url:cfg.url,key:cfg.key,key1:cfg.key,key2:key2,model:cfg.model||'gpt-oss:20b'};
}

function clearAllCards(){
  var ids=Object.keys(C);
  for(var i=0;i<ids.length;i++)removeCard(+ids[i]);
}

function applyPresetFromUI(){
  var preset=$$('presetSelect').value;
  if(!preset||!BENCHMARK_PRESETS[preset]){toast('Preset w√§hlen','err');return}
  var base=getFirstCardBase();
  var cards=BENCHMARK_PRESETS[preset](base);
  clearAllCards();
  for(var i=0;i<cards.length;i++)addCard(cards[i]);
  toast('Preset geladen: '+preset);
}

function getProfiles(){
  try{return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}')}catch(e){return{}};
}

function setProfiles(p){
  localStorage.setItem(PROFILE_KEY,JSON.stringify(p));
}

function refreshProfileSelect(){
  var el=$$('profileSelect');
  if(!el)return;
  var p=getProfiles();
  var names=Object.keys(p).sort();
  var html='<option value="">Benchmark-Profil‚Ä¶</option>';
  for(var i=0;i<names.length;i++)html+='<option value="'+esc(names[i])+'">'+esc(names[i])+'</option>';
  el.innerHTML=html;
}

function saveBenchmarkProfile(){
  var name=(prompt('Profilname speichern als:')||'').trim();
  if(!name){toast('Kein Profilname','err');return}
  var ids=Object.keys(C);
  if(ids.length===0){toast('Keine Karten vorhanden','err');return}
  var cards=[];
  for(var i=0;i<ids.length;i++)cards.push(getConf(+ids[i]));
  var profiles=getProfiles();
  profiles[name]={createdAt:new Date().toISOString(),cards:cards};
  setProfiles(profiles);
  refreshProfileSelect();
  $$('profileSelect').value=name;
  toast('Profil gespeichert: '+name);
}

function loadBenchmarkProfile(){
  var name=$$('profileSelect').value;
  if(!name){toast('Profil w√§hlen','err');return}
  var profiles=getProfiles();
  var p=profiles[name];
  if(!p||!p.cards||!p.cards.length){toast('Profil leer/ung√ºltig','err');return}
  clearAllCards();
  for(var i=0;i<p.cards.length;i++)addCard(p.cards[i]);
  toast('Profil geladen: '+name);
}

function deleteBenchmarkProfile(){
  var name=$$('profileSelect').value;
  if(!name){toast('Profil w√§hlen','err');return}
  var profiles=getProfiles();
  if(!profiles[name]){toast('Profil nicht gefunden','err');return}
  delete profiles[name];
  setProfiles(profiles);
  refreshProfileSelect();
  toast('Profil gel√∂scht: '+name);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENT MODEL CONFIG STORAGE (via /data/ WebDAV)
// Configs persist as JSON files in Docker volume
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _modelConfigCache=null;
var _modelConfigLoading=false;

function modelConfigFileName(name){
  return 'model_'+name.replace(/[^a-zA-Z0-9_\-√§√∂√º√Ñ√ñ√ú√ü]/g,'_')+'.json';
}

function fetchModelConfigs(cb){
  fetch('/data/?'+Date.now()).then(function(r){
    if(!r.ok){_modelConfigCache={};cb({});return}
    return r.json();
  }).then(function(listing){
    if(!listing){_modelConfigCache={};cb({});return}
    var files=(listing||[]).filter(function(f){return f.name&&f.name.indexOf('model_')===0&&f.name.indexOf('.json')>0});
    if(files.length===0){_modelConfigCache={};cb({});return}
    var results={},pending=files.length;
    files.forEach(function(f){
      fetch('/data/'+f.name+'?'+Date.now()).then(function(r){return r.json()}).then(function(data){
        if(data&&data.name)results[data.name]=data;
      }).catch(function(){}).then(function(){
        pending--;
        if(pending<=0){_modelConfigCache=results;cb(results)}
      });
    });
  }).catch(function(){
    // Fallback: try localStorage
    try{_modelConfigCache=JSON.parse(localStorage.getItem(MODEL_CFG_KEY)||'{}');}catch(e){_modelConfigCache={};}
    cb(_modelConfigCache);
  });
}

function saveModelConfigToServer(name,data,cb){
  var fname=modelConfigFileName(name);
  var payload=JSON.stringify(data,null,2);
  fetch('/data/'+fname,{method:'PUT',body:payload,headers:{'Content-Type':'application/json'}})
    .then(function(r){
      if(!r.ok)throw new Error('HTTP '+r.status);
      // Also backup to localStorage
      try{
        var all=JSON.parse(localStorage.getItem(MODEL_CFG_KEY)||'{}');
        all[name]=data;
        localStorage.setItem(MODEL_CFG_KEY,JSON.stringify(all));
      }catch(e){}
      if(cb)cb(true);
    }).catch(function(e){
      toast('Speichern auf Server fehlgeschlagen: '+e.message+' ‚Äì nutze localStorage','err');
      try{
        var all=JSON.parse(localStorage.getItem(MODEL_CFG_KEY)||'{}');
        all[name]=data;
        localStorage.setItem(MODEL_CFG_KEY,JSON.stringify(all));
      }catch(ex){}
      if(cb)cb(false);
    });
}

function deleteModelConfigFromServer(name,cb){
  var fname=modelConfigFileName(name);
  fetch('/data/'+fname,{method:'DELETE'})
    .then(function(){return})
    .catch(function(){})
    .then(function(){
      try{
        var all=JSON.parse(localStorage.getItem(MODEL_CFG_KEY)||'{}');
        delete all[name];
        localStorage.setItem(MODEL_CFG_KEY,JSON.stringify(all));
      }catch(e){}
      if(cb)cb();
    });
}

function refreshModelConfigSelect(){
  fetchModelConfigs(function(configs){
    var el=$$('modelCfgSelect');
    if(!el)return;
    var names=Object.keys(configs).sort();
    var html='<option value="">Modell-Konfig‚Ä¶ ('+names.length+')</option>';
    for(var i=0;i<names.length;i++)html+='<option value="'+esc(names[i])+'">'+esc(names[i])+'</option>';
    el.innerHTML=html;
  });
}

function pickCardId(action){
  var ids=Object.keys(C);
  if(ids.length===0)return null;
  if(ids.length===1)return +ids[0];
  var lines=[];
  for(var i=0;i<ids.length;i++){
    var id=+ids[i],m=$$('m'+id);
    lines.push(id+': '+((m&&m.value)?m.value:'Neues Modell'));
  }
  var raw=(prompt('Karten-ID f√ºr '+action+' w√§hlen:\n'+lines.join('\n'),ids[0])||'').trim();
  if(!raw)return null;
  var pick=parseInt(raw,10);
  if(!C[pick]){toast('Ung√ºltige Karten-ID','err');return null}
  return pick;
}

function toModelConfig(cfg){
  return{
    url:cfg.url,
    key:cfg.key,
    model:cfg.model,
    sysPrompt:cfg.sysPrompt,
    prompt:cfg.prompt,
    batch:cfg.batch,
    delay:cfg.delay,
    total:cfg.total,
    conc:cfg.conc,
    maxTok:cfg.maxTok,
    temp:cfg.temp,
    priority:cfg.priority,
    stream:cfg.stream,
    sslVerify:cfg.sslVerify
  };
}

function normalizeModelConfig(cfg){
  var out=Object.assign({},cfg||{});
  if(out.conc===undefined||out.conc===null||isNaN(parseInt(out.conc,10)))out.conc=0;
  out.conc=parseInt(out.conc,10)||0;
  delete out.useQueue;
  return out;
}

function saveModelConfig(){
  var id=pickCardId('Speichern');
  if(id===null){toast('Keine Karte gew√§hlt','err');return}
  var cfg=toModelConfig(getConf(id));
  var defName=cfg.model||'Neues Modell';
  var name=(prompt('Modell-Konfig speichern als:',defName)||'').trim();
  if(!name){toast('Kein Name','err');return}
  var data={name:name,createdAt:new Date().toISOString(),config:cfg};
  saveModelConfigToServer(name,data,function(){
    refreshModelConfigSelect();
    toast('Modell-Konfig gespeichert: '+name);
  });
}

function loadModelConfig(){
  var name=$$('modelCfgSelect').value;
  if(!name){toast('Modell-Konfig w√§hlen','err');return}
  fetchModelConfigs(function(all){
    var entry=all[name];
    var cfg=entry&&entry.config?entry.config:entry;
    cfg=normalizeModelConfig(cfg);
    if(!cfg||!cfg.model){toast('Modell-Konfig ung√ºltig','err');return}
    addCard(cfg);
    toast('Modell-Konfig geladen: '+name);
  });
}

function deleteModelConfig(){
  var name=$$('modelCfgSelect').value;
  if(!name){toast('Modell-Konfig w√§hlen','err');return}
  if(!confirm('Modell-Konfig "'+name+'" wirklich l√∂schen?'))return;
  deleteModelConfigFromServer(name,function(){
    refreshModelConfigSelect();
    toast('Modell-Konfig gel√∂scht: '+name);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKER LOOP ‚Äì rein zeitgesteuert
// Feuert alle <delay> ms genau <batch> Requests ab,
// unabh√§ngig davon wie viele noch in-flight sind.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(id,cfg){
  var c=C[id];
  c.loopTimer=null;
  if(!c||!c.run)return;
  // Re-read mutable settings from inputs on each iteration (live-edit)
  var live=getLiveConf(id,cfg);
  if(live.total>0&&c.sent>=live.total){
    if(c.active===0){
      c.run=false;c.tEnd=Date.now();
      elog('test_done',id,{sent:c.sent,ok:c.ok,fail:c.fail,
        elapsed_s:c.t0?((c.tEnd-c.t0)/1000):0,
        serverRpmLimit:c.serverRpmLimit,serverMaxParallel:c.serverMaxParallel,serverParallelRemaining:c.serverParallelRemaining});
      toast(live.model+': Fertig ('+c.ok+'/'+c.sent+' OK)','ok');
    }
    return;
  }
  var batchN=Math.max(1,live.batch);
  if(live.total>0) batchN=Math.min(batchN,live.total-c.sent);
  for(var b=0;b<batchN;b++){
    if(live.total>0&&c.sent>=live.total)break;
    if(live.conc>0&&c.active>=live.conc)break; // Parallellimit einhalten
    fire(id,live);
  }
  scheduleLoop(id,live);
}

function scheduleLoop(id,cfg){
  var c=C[id];
  if(!c||!c.run||c.loopTimer)return;
  if(cfg.total>0&&c.sent>=cfg.total)return;
  var delay=Math.max(0,cfg.delay||0);
  if(delay>0){
    var now=performance.now();
    if(!c.nextSendAt) c.nextSendAt=now+delay;
    else c.nextSendAt+=delay;
    // wenn zu weit hinterher (>2x delay) ‚Üí reset
    if(c.nextSendAt<now-delay) c.nextSendAt=now+delay;
    var wait=Math.max(1,c.nextSendAt-now);
    c.loopTimer=setTimeout(function(){loop(id,cfg)},wait);
  }else{
    c.loopTimer=setTimeout(function(){loop(id,cfg)},0);
  }
}

function fire(id,cfg){
  var c=C[id];
  c.sent++;c.active++;
  var sentAt=Date.now();
  c.dispatchTs.push(sentAt);
  if(c.dispatchTs.length>6000)c.dispatchTs.shift();
  var t0=performance.now();
  var msgs=[];
  if(cfg.sysPrompt)msgs.push({role:'system',content:cfg.sysPrompt});
  msgs.push({role:'user',content:cfg.prompt});
  var body=JSON.stringify({model:cfg.model,messages:msgs,max_tokens:cfg.maxTok,temperature:cfg.temp,stream:cfg.stream,priority:cfg.priority});
  var endpoint='/chat/completions';
  var target=(cfg.url||'')+endpoint;
  var hdrs={'Content-Type':'application/json','Authorization':'Bearer '+cfg.key};

  // ‚îÄ‚îÄ‚îÄ Streaming via WebSocket ‚îÄ‚îÄ‚îÄ
  if(cfg.stream){
    return wsEnsureReady().then(function(){
      return new Promise(function(resolve,reject){
        if(!WS.ready||!WS.sock||WS.sock.readyState!==1){
          return reject(new Error('WebSocket nicht verbunden (state='+(WS.sock?WS.sock.readyState:'null')+')'));
        }
        var wsId=String(++WS.seq);
        var text='',sTok=0,pTok=0,ttfb=0,firstChunk=true;
        WS.cbs[wsId]={
          resolve:function(msg){
            // stream_end: Ergebnis verarbeiten
            var lat=performance.now()-t0;
            var tps=sTok>0&&lat>0?sTok/(lat/1000):0;
            var tTok=pTok+sTok;
            c.ok++;c.lats.push(lat);c.ttfbs.push(ttfb);
            c.promptTok+=pTok;c.compTok+=sTok;c.totalTok+=tTok;
            c.promptTokPerReq.push(pTok);c.compTokPerReq.push(sTok);c.totalTokPerReq.push(tTok);
            c.tpsPerReq.push(tps);if(tps>c.peakTps)c.peakTps=tps;
            recordThroughput(c,sTok);
            c.tl.push({t:Date.now(),lat:lat,ok:true,tok:sTok});
            addLog(cfg.model,true,lat,ttfb,pTok,sTok,tTok,tps,cfg.priority,cfg.batch,text.slice(0,120));
            elog('req_ok',id,{lat_ms:Math.round(lat),ttfb_ms:Math.round(ttfb),p_tok:pTok,c_tok:sTok,t_tok:tTok,
              tps:Math.round(tps*10)/10,stream:true,sent:c.sent,ok:c.ok,active:c.active,
              rpm_limit:c.serverRpmLimit,max_parallel:c.serverMaxParallel,parallel_remaining:c.serverParallelRemaining,
              text:text.slice(0,80)});
            resolve();
          },
          reject:reject,
          onStart:function(msg){
            // Status + Headers aus stream_start
            var status=msg.status||200;
            var respHeaders=msg.headers||{};
            function hget(k){var lk=k.toLowerCase();for(var h in respHeaders){if(h.toLowerCase()===lk)return respHeaders[h]}return null}
            var lim=hget('x-ratelimit-limit-requests')||hget('x-ratelimit-rps')||hget('x-litellm-rps')||'';
            var limN=parseFloat(lim);if(!isNaN(limN)&&limN>0)c.serverRpsLimit=limN;
            var rpm=parseFloat(hget('x-litellm-key-rpm-limit')||'');if(!isNaN(rpm)&&rpm>0)c.serverRpmLimit=rpm;
            var maxP=parseFloat(hget('x-ratelimit-api_key-limit-max_parallel_requests')||'');if(!isNaN(maxP)&&maxP>0)c.serverMaxParallel=maxP;
            var remP=parseFloat(hget('x-ratelimit-api_key-remaining-max_parallel_requests')||'');if(!isNaN(remP))c.serverParallelRemaining=remP;
            if(status<200||status>=300){
              delete WS.cbs[wsId];
              reject({message:'HTTP '+status,code:status});
            }
          },
          onChunk:function(raw){
            if(firstChunk){ttfb=performance.now()-t0;firstChunk=false}
            var lines=raw.split('\n');
            for(var i=0;i<lines.length;i++){
              var line=lines[i];
              if(line.indexOf('data: ')!==0||line.indexOf('[DONE]')!==-1)continue;
              try{var ch=JSON.parse(line.slice(6));
                var d=ch.choices&&ch.choices[0]&&ch.choices[0].delta&&ch.choices[0].delta.content;
                if(d){sTok++;text+=d}
                if(ch.usage){sTok=ch.usage.completion_tokens||sTok;pTok=ch.usage.prompt_tokens||pTok}
              }catch(e){}
            }
          },
          chunks:[],status:0,headers:{}
        };
        try{
          WS.sock.send(JSON.stringify({id:wsId,url:target,method:'POST',headers:hdrs,body:body,stream:true}));
        }catch(e){
          delete WS.cbs[wsId];
          reject(new Error('WS send failed: '+e.message));
        }
      });
    }).catch(function(e){
      var lat=performance.now()-t0;c.fail++;c.lats.push(lat);
      c.tl.push({t:Date.now(),lat:lat,ok:false,tok:0});
      var m=errMsg(e),code=e.code||0,cat='net';
      if(code>=400&&code<500){c.e4++;cat='4xx'}
      else if(code>=500){c.e5++;cat='5xx'}
      else if(m.toLowerCase().indexOf('timeout')!==-1){c.eT++;cat='timeout'}
      else{c.eN++}
      c.errs.push({t:Date.now(),msg:m.slice(0,5000),cat:cat});
      addLog(cfg.model,false,lat,null,0,0,0,0,cfg.priority,cfg.batch,m.slice(0,600));
      elog('req_fail',id,{lat_ms:Math.round(lat),http_code:code,category:cat,error:m.slice(0,500),
        sent:c.sent,ok:c.ok,fail:c.fail,active:c.active,
        rpm_limit:c.serverRpmLimit,max_parallel:c.serverMaxParallel,parallel_remaining:c.serverParallelRemaining});
      if(c.fail<=3||c.fail%25===0)toast(cfg.model+': '+m.slice(0,120),'err');
    }).then(function(){
      c.active--;
      if(cfg.total>0&&c.sent>=cfg.total&&c.active===0){
        c.run=false;c.tEnd=Date.now();
        elog('test_done',id,{sent:c.sent,ok:c.ok,fail:c.fail,
          elapsed_s:c.t0?((c.tEnd-c.t0)/1000):0,
          serverRpmLimit:c.serverRpmLimit,serverMaxParallel:c.serverMaxParallel});
        toast(cfg.model+': Fertig','ok');
      }
    });
  }

  // ‚îÄ‚îÄ‚îÄ Non-Streaming via WebSocket ‚îÄ‚îÄ‚îÄ
  return wsFetch(target,'POST',hdrs,body,false).then(function(msg){
    var status=msg.status||200;
    var respHeaders=msg.headers||{};
    function hget(k){var lk=k.toLowerCase();for(var h in respHeaders){if(h.toLowerCase()===lk)return respHeaders[h]}return null}
    var lim=hget('x-ratelimit-limit-requests')||hget('x-ratelimit-rps')||hget('x-litellm-rps')||'';
    var limN=parseFloat(lim);if(!isNaN(limN)&&limN>0)c.serverRpsLimit=limN;
    var rpm=parseFloat(hget('x-litellm-key-rpm-limit')||'');if(!isNaN(rpm)&&rpm>0)c.serverRpmLimit=rpm;
    var maxP=parseFloat(hget('x-ratelimit-api_key-limit-max_parallel_requests')||'');if(!isNaN(maxP)&&maxP>0)c.serverMaxParallel=maxP;
    var remP=parseFloat(hget('x-ratelimit-api_key-remaining-max_parallel_requests')||'');if(!isNaN(remP))c.serverParallelRemaining=remP;
    if(status<200||status>=300){var code=status;throw{message:'HTTP '+code+': '+(msg.body||'').slice(0,5000),code:code}}
    var data=JSON.parse(msg.body||'{}');
    var lat=performance.now()-t0;
    var text=(data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)||'';
    var u=data.usage||{};
    var pTok=u.prompt_tokens||0,sTok=u.completion_tokens||0,tTok=u.total_tokens||(pTok+sTok);
    var tps=sTok>0&&lat>0?sTok/(lat/1000):0;
    c.ok++;c.lats.push(lat);
    c.promptTok+=pTok;c.compTok+=sTok;c.totalTok+=tTok;
    c.promptTokPerReq.push(pTok);c.compTokPerReq.push(sTok);c.totalTokPerReq.push(tTok);
    c.tpsPerReq.push(tps);if(tps>c.peakTps)c.peakTps=tps;
    recordThroughput(c,sTok);
    c.tl.push({t:Date.now(),lat:lat,ok:true,tok:sTok});
    addLog(cfg.model,true,lat,null,pTok,sTok,tTok,tps,cfg.priority,cfg.batch,text.slice(0,120));
    elog('req_ok',id,{lat_ms:Math.round(lat),p_tok:pTok,c_tok:sTok,t_tok:tTok,
      tps:Math.round(tps*10)/10,stream:false,sent:c.sent,ok:c.ok,active:c.active,
      rpm_limit:c.serverRpmLimit,max_parallel:c.serverMaxParallel,parallel_remaining:c.serverParallelRemaining,
      text:text.slice(0,80)});
  }).catch(function(e){
    if(e.name==='AbortError'){c.sent--;c.active--;return}
    var lat=performance.now()-t0;c.fail++;c.lats.push(lat);
    c.tl.push({t:Date.now(),lat:lat,ok:false,tok:0});
    var m=errMsg(e),code=e.code||0,cat='net';
    if(code>=400&&code<500){c.e4++;cat='4xx'}
    else if(code>=500){c.e5++;cat='5xx'}
    else if(m.toLowerCase().indexOf('timeout')!==-1){c.eT++;cat='timeout'}
    else{c.eN++}
    c.errs.push({t:Date.now(),msg:m.slice(0,5000),cat:cat});
    addLog(cfg.model,false,lat,null,0,0,0,0,cfg.priority,cfg.batch,m.slice(0,600));
    elog('req_fail',id,{lat_ms:Math.round(lat),http_code:code,category:cat,error:m.slice(0,500),
      sent:c.sent,ok:c.ok,fail:c.fail,active:c.active,
      rpm_limit:c.serverRpmLimit,max_parallel:c.serverMaxParallel,parallel_remaining:c.serverParallelRemaining});
    if(c.fail<=3||c.fail%25===0)toast(cfg.model+': '+m.slice(0,120),'err');
  }).then(function(){
    c.active--;
    if(cfg.total>0&&c.sent>=cfg.total&&c.active===0){
      c.run=false;c.tEnd=Date.now();
      elog('test_done',id,{sent:c.sent,ok:c.ok,fail:c.fail,
        elapsed_s:c.t0?((c.tEnd-c.t0)/1000):0,
        serverRpmLimit:c.serverRpmLimit,serverMaxParallel:c.serverMaxParallel});
      toast(cfg.model+': Fertig','ok');
    }
  });
}

function recordThroughput(c,tok){
  var now=Date.now(),bin=Math.floor(now/5000);
  var last=c.throughputBins[c.throughputBins.length-1];
  if(last&&last.bin===bin){last.tok+=tok;last.req++}
  else{c.throughputBins.push({bin:bin,tok:tok,req:1})}
  if(c.throughputBins.length>120)c.throughputBins.shift();
}

function addLog(model,ok,lat,ttfb,pTok,cTok,tTok,tps,priority,batch,text){
  LOG.unshift({time:new Date(),model:model,ok:ok,lat:lat,ttfb:ttfb,pTok:pTok,cTok:cTok,tTok:tTok,tps:tps,priority:priority,batch:batch,text:text});
  if(LOG.length>500)LOG.length=500;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRUCTURED EVENT LOG (for analysis)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function elog(event,cardId,data){
  var c=C[cardId];
  ELOG.push({
    seq:++ELOG_SEQ,
    ts:new Date().toISOString(),
    t_ms:Date.now(),
    event:event,
    card_id:cardId,
    model:c?c.model:'',
    key_label:c?c.keyLabel:'',
    priority:c?c.priority:0,
    data:data||{}
  });
  // keep max 50000 entries
  if(ELOG.length>50000)ELOG.splice(0,ELOG.length-50000);
}

function downloadEventLog(){
  if(ELOG.length===0){toast('Kein Event-Log vorhanden','err');return}
  // Build summary
  var summary={generated:new Date().toISOString(),total_events:ELOG.length};
  var cards=[];
  for(var id in C){
    var c=C[id],cfg=getConf(+id),s=calcStats(+id);
    cards.push({
      card_id:+id,
      config:{
        url:cfg.url,key_label:keyLabel(cfg.key),model:cfg.model,
        batch:cfg.batch,delay:cfg.delay,total:cfg.total,conc:cfg.conc,
        maxTok:cfg.maxTok,temp:cfg.temp,priority:cfg.priority,
        stream:cfg.stream,sslVerify:cfg.sslVerify
      },
      results:s?{
        sent:s.sent,ok:s.ok,fail:s.fail,
        elapsed_s:Math.round(s.elapsed*10)/10,
        rps:Math.round(s.rps*100)/100,
        lat_avg_ms:Math.round(s.avg),lat_p50_ms:Math.round(s.p50),
        lat_p95_ms:Math.round(s.p95),lat_p99_ms:Math.round(s.p99),
        lat_min_ms:Math.round(s.min),lat_max_ms:Math.round(s.max),
        c_tok_per_s:Math.round(s.compTokSec*10)/10,
        t_tok_per_s:Math.round(s.totalTokSec*10)/10,
        peak_tps:Math.round(s.peakTps*10)/10,
        prompt_tok:s.promptTok,comp_tok:s.compTok,total_tok:s.totalTok,
        ttfb_avg_ms:s.ttfbAvg!==null?Math.round(s.ttfbAvg):null,
        success_rate:Math.round(s.rate*10)/10,
        errors:{e4xx:s.e4,e5xx:s.e5,net:s.eN,timeout:s.eT},
        server_limits:{
          rpm_limit:c.serverRpmLimit,
          max_parallel:c.serverMaxParallel,
          parallel_remaining:c.serverParallelRemaining
        }
      }:null
    });
  }
  var out={summary:summary,cards:cards,events:ELOG};
  var blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='event-log-'+new Date().toISOString().replace(/[:.]/g,'-').slice(0,19)+'.json';
  a.click();
  toast('Event-Log heruntergeladen ('+ELOG.length+' Events)');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pct(arr,p){if(!arr.length)return 0;return arr[Math.min(Math.ceil(arr.length*p)-1,arr.length-1)]}
function arrAvg(a){if(!a.length)return 0;var s=0;for(var i=0;i<a.length;i++)s+=a[i];return s/a.length}
function arrStd(a){if(a.length<2)return 0;var m=arrAvg(a),v=0;for(var i=0;i<a.length;i++){var d=a[i]-m;v+=d*d}return Math.sqrt(v/a.length)}

function calcStats(id){
  var c=C[id];if(!c)return null;
  var s=c.lats.slice().sort(function(a,b){return a-b});
  var elapsed=c.t0?((c.tEnd||Date.now())-c.t0)/1000:0;
  var avg=arrAvg(s),stddev=arrStd(s);
  var cSorted=c.compTokPerReq.slice().sort(function(a,b){return a-b});
  var pSorted=c.promptTokPerReq.slice().sort(function(a,b){return a-b});
  var tSorted=c.totalTokPerReq.slice().sort(function(a,b){return a-b});
  var tpsSorted=c.tpsPerReq.slice().sort(function(a,b){return a-b});
  var ttfbSorted=c.ttfbs.slice().sort(function(a,b){return a-b});
  var rate=(c.ok+c.fail)>0?c.ok/(c.ok+c.fail)*100:0;
  var dInt=[];
  for(var i=1;i<c.dispatchTs.length;i++)dInt.push(c.dispatchTs[i]-c.dispatchTs[i-1]);
  var dSorted=dInt.slice().sort(function(a,b){return a-b});

  return{
    model:c.model,run:c.run,color:c.color,
    keyLabel:c.keyLabel,priority:c.priority,delayCfg:c.delayCfg,serverRpsLimit:c.serverRpsLimit,
    sent:c.sent,ok:c.ok,fail:c.fail,active:c.active,
    avg:avg,min:s[0]||0,max:s[s.length-1]||0,
    p50:pct(s,.5),p95:pct(s,.95),p99:pct(s,.99),stddev:stddev,
    rps:elapsed>0?(c.ok+c.fail)/elapsed:0,
    elapsed:elapsed,rate:rate,
    // token totals
    promptTok:c.promptTok,compTok:c.compTok,totalTok:c.totalTok,
    // per-second
    promptTokSec:elapsed>0?c.promptTok/elapsed:0,
    compTokSec:elapsed>0?c.compTok/elapsed:0,
    totalTokSec:elapsed>0?c.totalTok/elapsed:0,
    // per-request averages
    avgPTokReq:arrAvg(c.promptTokPerReq),avgCTokReq:arrAvg(c.compTokPerReq),avgTTokReq:arrAvg(c.totalTokPerReq),
    // per-request percentiles
    cTokP50:pct(cSorted,.5),cTokP95:pct(cSorted,.95),cTokMin:cSorted[0]||0,cTokMax:cSorted[cSorted.length-1]||0,
    pTokP50:pct(pSorted,.5),tTokP50:pct(tSorted,.5),
    // tps per request
    avgTpsReq:arrAvg(c.tpsPerReq),tpsP50:pct(tpsSorted,.5),tpsP95:pct(tpsSorted,.95),tpsMax:tpsSorted[tpsSorted.length-1]||0,
    peakTps:c.peakTps,
    // ttfb
    ttfbAvg:c.ttfbs.length?arrAvg(c.ttfbs):null,
    ttfbP50:ttfbSorted.length?pct(ttfbSorted,.5):null,
    ttfbP95:ttfbSorted.length?pct(ttfbSorted,.95):null,
    ttfbMin:ttfbSorted[0]||null,ttfbMax:ttfbSorted[ttfbSorted.length-1]||null,
    dispatchAvg:dInt.length?arrAvg(dInt):null,
    dispatchP50:dSorted.length?pct(dSorted,.5):null,
    dispatchMin:dSorted[0]||null,dispatchMax:dSorted[dSorted.length-1]||null,
    // io ratio
    ioRatio:c.promptTok>0?c.compTok/c.promptTok:0,
    // arrays for charts
    compTokPerReq:c.compTokPerReq,tpsPerReq:c.tpsPerReq,throughputBins:c.throughputBins,dispatchTs:c.dispatchTs,
    e4:c.e4,e5:c.e5,eN:c.eN,eT:c.eT,errs:c.errs,lats:c.lats,tl:c.tl
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  var gS=0,gO=0,gF=0,gA=0,gL=[],gCTR=[],gTPSR=[],gPT=0,gCT=0,gTT=0,gE=0,gTtfbs=0,gTtfbN=0,allS=[];

  for(var id in C){
    id=+id;var c=C[id],s=calcStats(id);if(!s)continue;allS.push(s);
    gS+=s.sent;gO+=s.ok;gF+=s.fail;gA+=s.active;
    gL=gL.concat(s.lats);gCTR=gCTR.concat(s.compTokPerReq);gTPSR=gTPSR.concat(s.tpsPerReq);
    gPT+=s.promptTok;gCT+=s.compTok;gTT+=s.totalTok;
    if(s.elapsed>gE)gE=s.elapsed;
    if(s.ttfbAvg!==null){gTtfbs+=s.ttfbAvg*c.ttfbs.length;gTtfbN+=c.ttfbs.length}

    // card styling
    c.el.className='card'+(s.run?' is-run':(s.sent>0?' is-done':''));
    var dot=$$('dot'+id);if(dot)dot.className='card-dot'+(s.run?' running':(s.sent>0?' done':''));
    var bdg=$$('bdg'+id);if(bdg){if(s.sent>0){bdg.style.display='';bdg.textContent=Math.round(s.rate)+'%'}else bdg.style.display='none'}
    var clk=$$('clk'+id);if(clk&&s.elapsed>0)clk.textContent=formatDur(s.elapsed);
    var total=parseInt($$('tr'+id).value)||0;
    var pb=$$('pb'+id);if(pb)pb.style.width=total>0?clamp(s.sent/total*100,0,100)+'%':(s.run?'100%':'0');
    setText('xS'+id,s.sent);setText('xO'+id,s.ok);setText('xF'+id,s.fail);setText('xA'+id,s.active);
    if(s.sent>0)$$('cs'+id).classList.add('vis');

    // Overview detail
    var det=$$('xD'+id);
    if(det&&s.sent>0){
      det.innerHTML=
        kv('Avg',fms(s.avg))+kv('P50',fms(s.p50))+kv('P95',fms(s.p95))+kv('P99',fms(s.p99))+
        kv('Min',fms(s.min))+kv('Max',fms(s.max))+kv('StdDev',fms(s.stddev))+kv('RPS',fn(s.rps,1))+
        kv('Erfolg',fn(s.rate,1)+'%')+kv('Dauer',fn(s.elapsed,1)+'s')+
        kv('Gesamt Tok',s.totalTok)+kv('C-Tok/s',fn(s.compTokSec,1));
    }
    // Latency chart
    var ch=$$('xC'+id);
    if(ch&&s.tl.length>0){
      var recent=s.tl.slice(-100),mx=1;
      for(var j=0;j<recent.length;j++)if(recent[j].lat>mx)mx=recent[j].lat;
      var h='';for(var j=0;j<recent.length;j++){var ht=Math.max(2,(recent[j].lat/mx)*30);h+='<div class="b '+(recent[j].ok?'ok':'fail')+'" style="height:'+ht+'px"></div>'}
      ch.innerHTML=h;
    }

    // Token tab
    setText('tPT'+id,s.promptTok);setText('tCT'+id,s.compTok);setText('tTT'+id,s.totalTok);
    setText('tCTps'+id,fn(s.compTokSec,1));setText('tTTps'+id,fn(s.totalTokSec,1));
    setText('tTtf'+id,s.ttfbAvg!==null?fms(s.ttfbAvg):'‚Äì');
    var tDet=$$('tD'+id);
    if(tDet&&s.compTokPerReq.length>0){
      tDet.innerHTML=
        kv('√ò P-Tok/Req',fn(s.avgPTokReq,1))+kv('√ò C-Tok/Req',fn(s.avgCTokReq,1))+kv('√ò T-Tok/Req',fn(s.avgTTokReq,1))+kv('I/O Ratio',fn(s.ioRatio,2))+
        kv('C-Tok Min',s.cTokMin)+kv('C-Tok Max',s.cTokMax)+kv('C-Tok P50',s.cTokP50)+kv('C-Tok P95',s.cTokP95)+
        kv('√ò Tok/s/Req',fn(s.avgTpsReq,1))+kv('Tok/s P50',fn(s.tpsP50,1))+kv('Tok/s P95',fn(s.tpsP95,1))+kv('Tok/s Peak',fn(s.peakTps,1))+
        (s.ttfbP50!==null?kv('TTFT P50',fms(s.ttfbP50)):'')+
        (s.ttfbP95!==null?kv('TTFT P95',fms(s.ttfbP95)):'')+
        (s.ttfbMin!==null?kv('TTFT Min',fms(s.ttfbMin)):'')+
        (s.ttfbMax!==null?kv('TTFT Max',fms(s.ttfbMax)):'');
    }
    // Completion tok bars
    renderBars($$('tB'+id),s.compTokPerReq,'var(--success)');
    // TPS bars
    renderBars($$('tpB'+id),s.tpsPerReq,'var(--cyan)');

    // Throughput tab
    setText('thrRps'+id,fn(s.rps,1));setText('thrTps'+id,fn(s.compTokSec,1));setText('thrPeak'+id,fn(s.peakTps,1));
    var thrD=$$('thrD'+id);
    if(thrD&&s.sent>0){
      thrD.innerHTML=
        kv('Total Req',s.sent)+kv('OK',s.ok)+kv('Fails',s.fail)+kv('Elapsed',fn(s.elapsed,1)+'s')+
        kv('Req/s',fn(s.rps,2))+kv('P-Tok/s',fn(s.promptTokSec,1))+kv('C-Tok/s',fn(s.compTokSec,1))+kv('T-Tok/s',fn(s.totalTokSec,1))+
        kv('Header-RPS',s.serverRpsLimit>0?fn(s.serverRpsLimit,1):'‚Äì')+
        kv('RPM Limit',s.serverRpmLimit>0?fn(s.serverRpmLimit,0):'‚Äì')+
        kv('Max Parallel',s.serverMaxParallel>0?fn(s.serverMaxParallel,0):'‚Äì')+
        kv('‚à• √ºbrig',s.serverMaxParallel>0?fn(s.serverParallelRemaining,0):'‚Äì')+
        kv('In-Flight',s.active)+
        kv('Delay Soll',s.delayCfg+'ms')+kv('ŒîSend √ò',s.dispatchAvg!==null?fn(s.dispatchAvg,1)+'ms':'‚Äì')+kv('ŒîSend P50',s.dispatchP50!==null?fn(s.dispatchP50,1)+'ms':'‚Äì');
    }
    // Throughput chart (RPS over time in 5s bins)
    var thrC=$$('thrC'+id);
    if(thrC&&s.throughputBins.length>1){
      var bins=s.throughputBins.slice(-60),mx=1;
      for(var j=0;j<bins.length;j++){var v=bins[j].req/5;if(v>mx)mx=v}
      var h='';for(var j=0;j<bins.length;j++){var v=bins[j].req/5;var ht=Math.max(2,(v/mx)*30);h+='<div class="b ok" style="height:'+ht+'px" title="'+fn(v,1)+' RPS"></div>'}
      thrC.innerHTML=h;
    }

    // Error tab
    setText('e4'+id,s.e4);setText('e5'+id,s.e5);setText('eN'+id,s.eN);setText('eT'+id,s.eT);
    var eL=$$('eL'+id);
    if(eL){
      if(s.errs.length>0){
        var eh='',errs=s.errs.slice(-120);
        for(var j=errs.length-1;j>=0;j--){
          var e=errs[j],cls=e.cat==='4xx'?'c4':e.cat==='5xx'?'c5':'cN';
          var dt=new Date(e.t);
          eh+='<div class="err-item"><span class="et">'+pad(dt.getHours())+':'+pad(dt.getMinutes())+':'+pad(dt.getSeconds())+'</span><span class="ec '+cls+'">'+e.cat+'</span><span class="em">'+esc(e.msg)+'</span></div>';
        }
        eL.innerHTML=eh;
      }else{
        eL.innerHTML='';
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var gR=gE>0?(gO+gF)/gE:0,gCTS=gE>0?gCT/gE:0,gTTS=gE>0?gTT/gE:0,gPTS=gE>0?gPT/gE:0;
  var errR=(gO+gF)>0?(gF/(gO+gF)*100):0,gRate=(gO+gF)>0?(gO/(gO+gF)*100):0;
  var gAvgCTok=gCTR.length?arrAvg(gCTR):0;
  var gTtfbAvg=gTtfbN>0?gTtfbs/gTtfbN:null;
  var gAvgTPS=gTPSR.length?arrAvg(gTPSR):0;
  var gPeakTPS=0;for(var id in C){var pc=C[id].peakTps;if(pc>gPeakTPS)gPeakTPS=pc}
  var keys=Object.keys(C).length;

  $$('kpiRow').innerHTML=
    kpi(gS,'Requests','')+kpi(gO,'OK','color:var(--success)')+kpi(gF,'Fehler','color:var(--error)')+
    kpi(gA,'Aktiv','color:var(--primary)')+kpi(fn(gR,1),'Req/s','')+
    kpi(gPT,'Prompt Tok','color:var(--warn)')+kpi(gCT,'Compl Tok','color:var(--success)')+kpi(gTT,'Gesamt Tok','')+
    kpi(fn(gPTS,1),'P-Tok/s','color:var(--warn)')+kpi(fn(gCTS,1),'C-Tok/s','color:var(--cyan)')+kpi(fn(gTTS,1),'T-Tok/s','')+
    kpi(fn(gAvgCTok,1),'√ò C-Tok/Req','')+kpi(fn(gAvgTPS,1),'√ò Tok/s/Req','color:var(--purple)')+
    kpi(fn(gPeakTPS,1),'Peak Tok/s','color:var(--lime)')+
    kpi(gTtfbAvg!==null?fms(gTtfbAvg):'‚Äì','√ò TTFT','color:var(--pink)')+
    kpi(fn(gRate,1)+'%','Erfolgsrate','color:var(--success)')+
    kpi(fn(errR,1)+'%','Fehlerrate','color:var(--error)')+
    kpi(keys,'Modelle','');

  // Server-Limit KPIs pro Karte
  var limHtml='';
  for(var li=0;li<allS.length;li++){
    var ls=allS[li];
    if(ls.serverMaxParallel>0||ls.serverRpmLimit>0){
      limHtml+=kpi(ls.serverRpmLimit>0?fn(ls.serverRpmLimit,0):'‚Äì','RPM '+ls.keyLabel,'color:var(--warn)');
      limHtml+=kpi(ls.serverMaxParallel>0?fn(ls.serverMaxParallel,0):'‚Äì','Max‚à• '+ls.keyLabel,'color:var(--cyan)');
      limHtml+=kpi(ls.serverMaxParallel>0?fn(ls.serverParallelRemaining,0):'‚Äì','‚à• frei '+ls.keyLabel,'color:'+(ls.serverParallelRemaining<5?'var(--error)':'var(--success)'));
      limHtml+=kpi(ls.active,'In-Flight '+ls.keyLabel,'color:var(--primary)');
    }
  }
  if(limHtml)$$('kpiRow').innerHTML+=limHtml;

  $$('dashClock').textContent=gE>0?formatDur(gE):'';

  renderHist(gL,$$('histBox'),[
    {l:'0‚Äì50ms',lo:0,hi:50,c:'var(--success)'},{l:'50‚Äì100ms',lo:50,hi:100,c:'var(--success)'},
    {l:'100‚Äì250ms',lo:100,hi:250,c:'var(--primary)'},{l:'250‚Äì500ms',lo:250,hi:500,c:'var(--primary)'},
    {l:'0.5‚Äì1s',lo:500,hi:1000,c:'var(--warn)'},{l:'1‚Äì3s',lo:1000,hi:3000,c:'var(--warn)'},
    {l:'3‚Äì10s',lo:3000,hi:10000,c:'var(--error)'},{l:'10s+',lo:10000,hi:Infinity,c:'var(--error)'}]);

  renderHist(gCTR,$$('tokHistBox'),[
    {l:'0‚Äì5',lo:0,hi:5,c:'var(--text2)'},{l:'5‚Äì10',lo:5,hi:10,c:'var(--cyan)'},
    {l:'10‚Äì25',lo:10,hi:25,c:'var(--primary)'},{l:'25‚Äì50',lo:25,hi:50,c:'var(--success)'},
    {l:'50‚Äì100',lo:50,hi:100,c:'var(--warn)'},{l:'100‚Äì200',lo:100,hi:200,c:'var(--warn)'},
    {l:'200+',lo:200,hi:Infinity,c:'var(--purple)'}]);

  renderHist(gTPSR,$$('tpsHistBox'),[
    {l:'0‚Äì1',lo:0,hi:1,c:'var(--error)'},{l:'1‚Äì5',lo:1,hi:5,c:'var(--warn)'},
    {l:'5‚Äì10',lo:5,hi:10,c:'var(--primary)'},{l:'10‚Äì25',lo:10,hi:25,c:'var(--cyan)'},
    {l:'25‚Äì50',lo:25,hi:50,c:'var(--success)'},{l:'50‚Äì100',lo:50,hi:100,c:'var(--lime)'},
    {l:'100+',lo:100,hi:Infinity,c:'var(--purple)'}]);

  renderLineChart($$('keyLineBox'),buildKeySeries(true),{unit:'',targetField:''});
  renderLineChart($$('rpsKeyBox'),buildKeySeries(false),{unit:' rps',targetField:''});
  renderLineChart($$('dispatchLineBox'),buildDispatchSeries(),{unit:' ms',targetField:'target'});
  renderPriorityCheck(allS);

  renderCmp(allS);
  renderLog();
  ensureInfoIcons();
}

function renderBars(el,arr,color){
  if(!el||!arr.length)return;
  var recent=arr.slice(-100),mx=1;
  for(var j=0;j<recent.length;j++)if(recent[j]>mx)mx=recent[j];
  var h='';for(var j=0;j<recent.length;j++){
    var ht=Math.max(2,(recent[j]/mx)*26);
    h+='<div style="flex:1;min-width:2px;border-radius:1px 1px 0 0;background:'+color+';opacity:.6;height:'+ht+'px"></div>';
  }el.innerHTML=h;
}

function renderHist(vals,el,buckets){
  if(!vals.length){el.innerHTML='<div style="color:var(--text2);font-size:12px">Keine Daten</div>';return}
  var counts=[],mx=1;
  for(var i=0;i<buckets.length;i++){var cnt=0;for(var j=0;j<vals.length;j++){if(vals[j]>=buckets[i].lo&&vals[j]<buckets[i].hi)cnt++}counts.push(cnt);if(cnt>mx)mx=cnt}
  var h='';for(var i=0;i<buckets.length;i++){
    h+='<div class="hr"><span class="hl">'+buckets[i].l+'</span><div class="hbg"><div class="hf" style="width:'+(counts[i]/mx*100)+'%;background:'+buckets[i].c+'"></div></div><span class="hc">'+counts[i]+'</span></div>';
  }el.innerHTML=h;
}

function buildKeySeries(cumulative){
  // globale Zeitbasis: fr√ºhester t0 aller Karten
  var globalT0=Infinity;
  for(var id in C){
    var c=C[id];
    if(c&&c.t0&&c.t0<globalT0) globalT0=c.t0;
  }
  if(globalT0===Infinity) globalT0=Date.now();

  var map={},globalMaxSec=0;
  for(var id in C){
    var c=C[id];
    if(!c||!c.t0||!c.tl.length)continue;
    var name=(c.keyLabel||'kein-key')+' | Prio '+(c.priority||0);
    if(!map[name])map[name]={name:name,color:c.color,counts:{}};
    for(var i=0;i<c.tl.length;i++){
      var ev=c.tl[i];
      if(!ev.ok)continue;
      var sec=Math.floor((ev.t-globalT0)/1000);
      if(sec<0)sec=0;
      map[name].counts[sec]=(map[name].counts[sec]||0)+1;
      if(sec>globalMaxSec)globalMaxSec=sec;
    }
  }
  var out=[],mx=Math.max(1,globalMaxSec);
  for(var k in map){
    var e=map[k],pts=[],run=0;
    for(var s=0;s<=mx;s++){
      var v=e.counts[s]||0;
      if(cumulative){run+=v;pts.push({x:s,y:run});}
      else pts.push({x:s,y:v});
    }
    e.points=pts;
    out.push(e);
  }
  return out;
}

function buildDispatchSeries(){
  var out=[];
  for(var id in C){
    var c=C[id];
    if(!c||!c.dispatchTs||c.dispatchTs.length<2)continue;
    var start=Math.max(1,c.dispatchTs.length-220),pts=[];
    for(var i=start;i<c.dispatchTs.length;i++)pts.push({x:i-start+1,y:c.dispatchTs[i]-c.dispatchTs[i-1]});
    out.push({
      name:(c.model||'Modell')+' | '+(c.keyLabel||'kein-key')+' | Prio '+(c.priority||0),
      color:c.color,
      points:pts,
      target:c.delayCfg||0
    });
  }
  return out;
}

function renderLineChart(el,series,opts){
  if(!el)return;
  opts=opts||{};
  if(!series.length){el.innerHTML='<div class="line-card"><div class="line-empty">Keine Daten</div></div>';return}
  var w=980,h=240,p=28,maxX=1,maxY=1;
  for(var i=0;i<series.length;i++){
    var pts=series[i].points||[];
    for(var j=0;j<pts.length;j++){
      if(pts[j].x>maxX)maxX=pts[j].x;
      if(pts[j].y>maxY)maxY=pts[j].y;
    }
    if(opts.targetField&&series[i][opts.targetField]>maxY)maxY=series[i][opts.targetField];
  }
  maxY=maxY<=0?1:maxY;
  function mx(v){return p+(v/maxX)*(w-p*2)}
  function my(v){return(h-p)-((v/maxY)*(h-p*2))}
  var svg='<svg class="line-svg" viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="none">';
  for(var g=0;g<=4;g++){
    var gy=p+((h-p*2)*(g/4));
    svg+='<line x1="'+p+'" y1="'+gy+'" x2="'+(w-p)+'" y2="'+gy+'" stroke="'+(g===4?'var(--border)':'rgba(148,163,184,.18)')+'" stroke-width="1" />';
  }
  svg+='<line x1="'+p+'" y1="'+(h-p)+'" x2="'+(w-p)+'" y2="'+(h-p)+'" stroke="var(--border)" stroke-width="1" />';
  for(var s=0;s<series.length;s++){
    var ser=series[s],pts2=ser.points||[];
    if(opts.targetField&&ser[opts.targetField]>0){
      var ty=my(ser[opts.targetField]);
      svg+='<line x1="'+p+'" y1="'+ty+'" x2="'+(w-p)+'" y2="'+ty+'" stroke="'+ser.color+'" stroke-opacity="0.55" stroke-dasharray="5 4" stroke-width="1" />';
    }
    if(!pts2.length)continue;
    var poly='';
    for(var t=0;t<pts2.length;t++)poly+=mx(pts2[t].x)+','+my(pts2[t].y)+' ';
    svg+='<polyline fill="none" stroke="'+ser.color+'" stroke-width="2" points="'+poly.trim()+'" />';
    var lp=pts2[pts2.length-1];
    svg+='<circle cx="'+mx(lp.x)+'" cy="'+my(lp.y)+'" r="2.5" fill="'+ser.color+'" />';
  }
  svg+='</svg>';
  var leg='<div class="line-legend">';
  for(var li=0;li<series.length;li++){
    var lser=series[li],lpts=lser.points||[],last=lpts.length?lpts[lpts.length-1].y:0;
    var extra=opts.targetField&&lser[opts.targetField]>0?(' ¬∑ Ziel '+fn(lser[opts.targetField],1)+(opts.unit||'')):'';
    leg+='<div class="line-item"><span class="line-dot" style="background:'+lser.color+'"></span>'+esc(lser.name)+' ¬∑ '+fn(last,1)+(opts.unit||'')+extra+'</div>';
  }
  leg+='</div>';
  el.innerHTML='<div class="line-card">'+svg+leg+'</div>';
}

function renderPriorityCheck(allS){
  var el=$$('prioCheckBox');
  if(!el)return;
  var rows=allS.filter(function(s){return s.sent>0});
  if(rows.length<2){
    el.innerHTML='<div class="line-card"><div class="line-empty">F√ºr den Check bitte mindestens 2 Karten mit unterschiedlicher Priorit√§t starten.</div></div>';
    return;
  }
  var minP=Infinity,maxP=-Infinity;
  for(var i=0;i<rows.length;i++){
    var p=rows[i].priority||0;
    if(p<minP)minP=p;
    if(p>maxP)maxP=p;
  }
  if(minP===maxP){
    el.innerHTML='<div class="line-card"><div class="line-empty">Alle Karten haben die gleiche Priorit√§t ('+minP+'). F√ºr Vergleich zwei unterschiedliche Werte setzen (z. B. 0 und 200).</div></div>';
    return;
  }
  function agg(list){
    var out={sent:0,ok:0,fail:0,latW:0,elapsed:0,p50:0,p95:0};
    for(var j=0;j<list.length;j++){
      var s=list[j],w=Math.max(1,s.ok+s.fail);
      out.sent+=s.sent;out.ok+=s.ok;out.fail+=s.fail;
      out.latW+=s.avg*w;
      if(s.elapsed>out.elapsed)out.elapsed=s.elapsed;
      out.p50+=s.p50*w;out.p95+=s.p95*w;
    }
    var tw=Math.max(1,out.ok+out.fail);
    out.avg=out.latW/tw;
    out.p50=out.p50/tw;
    out.p95=out.p95/tw;
    out.okps=out.elapsed>0?out.ok/out.elapsed:0;
    return out;
  }
  var high=agg(rows.filter(function(s){return (s.priority||0)===minP;}));
  var low=agg(rows.filter(function(s){return (s.priority||0)===maxP;}));
  var latGain=low.avg>0?((low.avg-high.avg)/low.avg*100):0;
  var p50Gain=low.p50>0?((low.p50-high.p50)/low.p50*100):0;
  var thrGain=low.okps>0?((high.okps-low.okps)/low.okps*100):0;
  var okBetter=high.okps>=low.okps;
  var latBetter=high.avg<=low.avg;
  var good=okBetter&&latBetter;
  var color=good?'var(--success)':'var(--warn)';
  var txt='<div class="line-card">'+
    '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Vergleich h√∂chste Priorit√§t (Prio '+minP+') vs niedrigste Priorit√§t (Prio '+maxP+')</div>'+
    '<div style="display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:8px">'+
      '<div class="kpi"><div class="v" style="color:'+color+'">'+fn(thrGain,1)+'%</div><div class="k">OK/s Vorteil Prio '+minP+'</div></div>'+
      '<div class="kpi"><div class="v" style="color:'+color+'">'+fn(latGain,1)+'%</div><div class="k">√ò Latenz Reduktion</div></div>'+
      '<div class="kpi"><div class="v" style="color:'+color+'">'+fn(p50Gain,1)+'%</div><div class="k">P50 Latenz Reduktion</div></div>'+
    '</div>'+
    '<div style="font-size:12px;color:var(--text2);margin-top:8px">'+
      'Prio '+minP+': '+fn(high.okps,2)+' OK/s, √ò '+fms(high.avg)+', P50 '+fms(high.p50)+' ¬∑ '+
      'Prio '+maxP+': '+fn(low.okps,2)+' OK/s, √ò '+fms(low.avg)+', P50 '+fms(low.p50)+
    '</div>'+
  '</div>';
  el.innerHTML=txt;
}

function renderCmp(allS){
  var el=$$('cmpTbl');if(!allS.length){el.innerHTML='';return}
  var cols=['Modell','Req','OK','Fail','Rate','Avg','P50','P95','P99','StdDev','RPS',
    'P-Tok','C-Tok','T-Tok','P-Tok/s','C-Tok/s','T-Tok/s',
    '√ò C-Tok/Req','√ò Tok/s/Req','Peak Tok/s','√ò TTFT','Dauer'];
  var data=allS.filter(function(s){return s.sent>0}).map(function(s){
    return[s.model,s.sent,s.ok,s.fail,fn(s.rate,1)+'%',
      fms(s.avg),fms(s.p50),fms(s.p95),fms(s.p99),fms(s.stddev),fn(s.rps,1),
      s.promptTok,s.compTok,s.totalTok,
      fn(s.promptTokSec,1),fn(s.compTokSec,1),fn(s.totalTokSec,1),
      fn(s.avgCTokReq,1),fn(s.avgTpsReq,1),fn(s.peakTps,1),
      s.ttfbAvg!==null?fms(s.ttfbAvg):'‚Äì',fn(s.elapsed,1)+'s'];
  });
  if(SORT.col!==null&&SORT.col<cols.length){
    var ci=SORT.col,asc=SORT.asc;
    data.sort(function(a,b){
      var va=parseFloat(String(a[ci]).replace(/[ms%‚Äì]/g,''))||0;
      var vb=parseFloat(String(b[ci]).replace(/[ms%‚Äì]/g,''))||0;
      return asc?va-vb:vb-va;
    });
  }
  var h='<thead><tr>';
  for(var i=0;i<cols.length;i++){var arrow=SORT.col===i?(SORT.asc?' ‚ñ≤':' ‚ñº'):'';h+='<th onclick="sortCmp('+i+')">'+cols[i]+'<span class="arrow">'+arrow+'</span></th>'}
  h+='</tr></thead><tbody>';
  for(var i=0;i<data.length;i++){h+='<tr>';for(var j=0;j<data[i].length;j++){h+='<td'+(j===0?' style="font-weight:600"':'')+'>'+data[i][j]+'</td>'}h+='</tr>'}
  el.innerHTML=h+'</tbody>';
}
function sortCmp(col){if(SORT.col===col)SORT.asc=!SORT.asc;else{SORT.col=col;SORT.asc=true}}

function renderLog(){
  var tbody=$$('logTbl').querySelector('tbody');
  var h='',n=Math.min(LOG.length,100);
  for(var i=0;i<n;i++){
    var r=LOG[i],t=r.time;
    var ts=pad(t.getHours())+':'+pad(t.getMinutes())+':'+pad(t.getSeconds())+'.'+String(t.getMilliseconds()).padStart(3,'0');
    h+='<tr><td>'+ts+'</td><td>'+esc(r.model)+'</td><td class="'+(r.ok?'s-ok':'s-err')+'">'+(r.ok?'‚úì':'‚úó')+'</td><td>'+fms(r.lat)+'</td><td>'+(r.ttfb!==null?fms(r.ttfb):'‚Äì')+'</td><td>'+(r.pTok||'‚Äì')+'</td><td>'+(r.cTok||'‚Äì')+'</td><td>'+(r.tTok||'‚Äì')+'</td><td>'+(r.tps?fn(r.tps,1):'‚Äì')+'</td><td>'+r.priority+'</td><td>'+r.batch+'</td><td class="ans">'+esc(r.text)+'</td></tr>';
  }
  tbody.innerHTML=h;
  if($$('logAuto').checked)$$('logScroll').scrollTop=0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT / CLIPBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON(){
  var out={ts:new Date().toISOString(),cards:[]};
  for(var id in C){out.cards.push({config:getConf(+id),stats:calcStats(+id)})}
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(out,null,2)],{type:'application/json'}));
  a.download='loadtest-'+Date.now()+'.json';a.click();toast('Export gespeichert');
}
function importJSON(){$$('importFile').click()}
function handleImport(ev){
  var f=ev.target.files[0];if(!f)return;
  var reader=new FileReader();reader.onload=function(e){
    try{var data=JSON.parse(e.target.result);if(data.cards){for(var i=0;i<data.cards.length;i++)addCard(data.cards[i].config);toast(data.cards.length+' Karten importiert')}}
    catch(err){toast('Import fehlgeschlagen: '+err.message,'err')}
  };reader.readAsText(f);ev.target.value='';
}
function copyClipboard(){
  var out=[];
  for(var id in C){
    var s=calcStats(+id);if(!s||s.sent===0)continue;
    out.push(s.model+': '+s.sent+' req, '+s.ok+' ok, Avg='+fms(s.avg)+', P95='+fms(s.p95)+
      ', C-Tok/s='+fn(s.compTokSec,1)+', T-Tok/s='+fn(s.totalTokSec,1)+
      ', PromptTok='+s.promptTok+', CompTok='+s.compTok+', TotalTok='+s.totalTok+
      ', Peak='+fn(s.peakTps,1)+' tok/s, '+fn(s.rate,0)+'% OK');
  }
  if(!out.length){toast('Keine Ergebnisse','err');return}
  navigator.clipboard.writeText(out.join('\n')).then(function(){toast('In Zwischenablage kopiert')});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setText(elId,v){var e=$$(elId);if(e)e.textContent=v}
function kv(k,v){return'<dt>'+k+'</dt><dd>'+v+'</dd>'}
function kpi(v,label,style){return'<div class="kpi"><div class="v"'+(style?' style="'+style+'"':'')+'>'+v+'</div><div class="k">'+label+'</div></div>'}
function pad(n){return String(n).padStart(2,'0')}
function formatDur(sec){if(sec<60)return sec.toFixed(1)+'s';var m=Math.floor(sec/60),s=Math.floor(sec%60);return m+'m '+pad(s)+'s'}

document.addEventListener('keydown',function(e){
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
  if(e.key==='n'||e.key==='N'){e.preventDefault();addCard()}
  if(e.key==='s'&&!e.ctrlKey){e.preventDefault();startAll()}
  if(e.key==='x'||e.key==='X'){e.preventDefault();stopAll()}
  if(e.key==='r'&&!e.ctrlKey){e.preventDefault();resetAll()}
  if(e.key==='e'||e.key==='E'){e.preventDefault();exportJSON()}
});

setInterval(render,400);render();
refreshProfileSelect();
refreshModelConfigSelect();
</script>
</body>
</html>
