<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LLM Load Tester Â· HPE</title>
<style>
:root{
  color-scheme:light;
  --bg:#F2F2F2;--panel:#FFFFFF;--panel2:#F7F7F7;--line:#CCCCCC;
  --text:#333333;--muted:#999999;--dim:#666666;
  --accent:#01A982;--ok:#01A982;--warn:#FFBC44;--err:#FF4040;
  --accent-hover:#008567;--hpe-green:#01A982;--hpe-blue:#00739D;--hpe-purple:#7630EA;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI','Inter',system-ui,-apple-system,sans-serif}
button,input,textarea,select{font:inherit}
button{border:1px solid var(--line);background:var(--panel);color:var(--text);padding:7px 11px;border-radius:8px;cursor:pointer;transition:all .15s}
button:hover{border-color:var(--accent);color:var(--accent)}
button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
button.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover);color:#fff}
button.success{background:var(--ok);border-color:var(--ok);color:#fff}
button.success:hover{background:var(--accent-hover);border-color:var(--accent-hover);color:#fff}
button.danger{background:var(--err);border-color:var(--err);color:#fff}
button.danger:hover{background:#d63030;border-color:#d63030;color:#fff}
button:disabled{opacity:.55;cursor:not-allowed}
input,textarea,select{width:100%;background:#FFF;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:7px 9px;transition:border-color .2s,box-shadow .2s}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(1,169,130,.15)}
textarea{min-height:58px;resize:vertical}
.wrap{max-width:1720px;margin:12px auto;padding:0 10px;display:grid;gap:10px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.head{padding:12px 14px;display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.title{font-size:19px;margin:0}
.sub{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:7px;flex-wrap:wrap}
.badge{border:1px solid var(--line);background:var(--panel2);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:11px}
.badge.ok{color:var(--ok);border-color:rgba(1,169,130,.4)}
.badge.err{color:var(--err);border-color:rgba(255,64,64,.4)}
.tools{padding:0 14px 14px;display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:9px}
.box{grid-column:span 6;border:1px solid var(--line);background:var(--panel2);border-radius:9px;padding:9px;display:grid;gap:7px}
.box h2{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.row{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:7px}
.s2{grid-column:span 2}.s3{grid-column:span 3}.s4{grid-column:span 4}.s5{grid-column:span 5}.s6{grid-column:span 6}.s7{grid-column:span 7}.s8{grid-column:span 8}.s9{grid-column:span 9}.s12{grid-column:span 12}
.field{display:grid;gap:3px}
.lab{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:11px;color:var(--muted)}
.help{width:18px;height:18px;min-width:18px;border-radius:50%;padding:0;font-weight:700;font-size:11px}
.help-pop{position:absolute;right:0;top:calc(100% + 6px);width:min(340px,75vw);z-index:30;border:1px solid var(--line);background:var(--panel);border-radius:8px;padding:9px;box-shadow:0 4px 20px rgba(0,0,0,.12)}
.help-pop h4{margin:0 0 5px;font-size:12px}
.help-pop p{margin:0;font-size:12px;line-height:1.45;color:var(--muted)}
.help-wrap{position:relative;display:inline-flex}
.cards{padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(460px,1fr));gap:9px}
.card{border:1px solid var(--line);border-radius:9px;background:var(--panel);overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.card.run{border-color:rgba(1,169,130,.6)}
.card.done{border-color:rgba(1,169,130,.4)}
.card-h{padding:9px 10px;background:var(--panel2);border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
.dot{width:9px;height:9px;border-radius:50%;background:#CCC}.dot.run{background:var(--accent)}.dot.done{background:var(--ok)}
.c-t{flex:1;min-width:0}.c-t .m{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.c-t .s{font-size:11px;color:var(--dim)}
.c-a{display:flex;gap:6px;flex-wrap:wrap}
.card-b{padding:9px 10px;display:grid;gap:7px}
.prog{height:4px;background:#E8E8E8;border-radius:4px;overflow:hidden}
.prog>div{height:100%;background:linear-gradient(90deg,var(--accent),#17EBA0)}
.mgrid{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:6px}
.m{border:1px solid var(--line);border-radius:7px;background:var(--panel2);text-align:center;padding:6px}
.m .v{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums}.m .k{font-size:10px;color:var(--muted);margin-top:2px;text-transform:uppercase}
.errs{display:grid;gap:3px;max-height:110px;overflow:auto}
.err{border:1px solid rgba(255,64,64,.2);background:rgba(255,64,64,.06);color:var(--err);font-size:11px;padding:4px 7px;border-radius:6px}
.main{display:grid;grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);gap:9px;padding:0 10px 10px}
.sec{padding:10px;display:grid;gap:8px}
.st{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.kpi{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:7px}
.k{border:1px solid var(--line);border-radius:8px;background:var(--panel);padding:8px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.k .v{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums}.k .l{font-size:10px;color:var(--muted);margin-top:2px;text-transform:uppercase}
.tblw{max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:8px}
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th,.tbl td{padding:6px 7px;border-bottom:1px solid var(--line);text-align:left;font-variant-numeric:tabular-nums}
.tbl th{position:sticky;top:0;background:var(--panel2);color:var(--muted);cursor:pointer;white-space:nowrap}
.logw{max-height:470px;overflow:auto;border:1px solid var(--line);border-radius:8px}
.ok{color:var(--ok)}.ko{color:var(--err)}
.toastL{position:fixed;right:14px;bottom:14px;display:grid;gap:6px;z-index:50}
.toast{background:var(--panel);border:1px solid var(--line);border-left:3px solid var(--accent);border-radius:8px;padding:8px 10px;font-size:12px;min-width:220px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.toast.success{border-left-color:var(--ok)}.toast.warn{border-left-color:var(--warn)}.toast.error{border-left-color:var(--err)}
.small{font-size:11px;color:var(--muted)}
@media(max-width:1280px){.box{grid-column:span 12}.main{grid-template-columns:1fr}}
@media(max-width:980px){.cards{grid-template-columns:1fr}.mgrid{grid-template-columns:repeat(4,minmax(0,1fr))}}
@media(max-width:760px){.s2,.s3,.s4,.s5,.s6,.s7,.s8,.s9,.s12{grid-column:span 12}.mgrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<div id="app"></div>
<script src="/web_vendor/react.development.js"></script>
<script src="/web_vendor/react-dom.development.js"></script>
<script src="/web_vendor/babel.min.js"></script>
<script type="text/babel" data-presets="env,react">
const {useState,useEffect,useMemo,useRef,useCallback}=React;
const SK={cards:'lt_cards_v4',profiles:'lt_profiles_v4',mcfg:'lt_mcfg_v4'};
const HELP={
  preset:['Preset','Vorgefertigte Lastprofile fuer reproduzierbare Startszenarien. Danach kann jede Karte weiter angepasst werden.'],
  profile:['Benchmark-Profil','Speichert den kompletten Kartensatz lokal im Browser. Profilnamen werden alphabetisch sortiert.'],
  mcfg:['Modell-Konfiguration','Speichert genau eine Karte als JSON auf /data und lokal als Fallback.'],
  url:['API Base URL','Basis des Zielendpunktes. Ein optionales /v1 wird automatisch bereinigt, damit keine doppelten Pfade entstehen.'],
  key:['API Key','Bearer-Token fuer das Zielsystem. Wird in Profilen/Konfigurationen mitgespeichert.'],
  model:['Modell','Model-ID fuer /v1/chat/completions. Ueber "Modelle laden" kann die Liste direkt vom Ziel geladen werden.'],
  sys:['System Prompt','Optionaler Systemtext. Beeinflusst Prompt-Tokens und damit Token-Durchsatzmessungen.'],
  prompt:['User Prompt','Nutzprompt je Request. Fuer belastbare Vergleiche Prompt zwischen Runs unveraendert lassen.'],
  total:['Requests gesamt','0 bedeutet Endlosschleife bis Stop. Feste Werte sind fuer vergleichbare Runs besser.'],
  par:['Max Parallel','Begrenzt gleichzeitig laufende Requests pro Karte. 0 bedeutet unbegrenzt.'],
  delay:['Intervall ms','Pause nach jeder Dispatch-Aktion. 0 sendet maximal schnell.'],
  maxTok:['Max Tokens','Maximale Completion Tokens je Request.'],
  temp:['Temperatur','Sampling-Temperatur fuer Generierung. Niedrige Werte sind reproduzierbarer.'],
  prio:['Prioritaet','Optionales Scheduler-Feld im Request-Body. Kleinere Werte oft hoeher priorisiert.'],
  stream:['Streaming','Aktiviert SSE-Streaming und TTFB-Messung.'],
  tls:['TLS Verifikation','Nur fuer Test gegen selbstsignierte Zertifikate deaktivieren.'],
  batch:['Batch Marker','Freie Kennzahl fuer Logs/Event-Export.'],
  dash:['Dashboard','Globale Aggregation ueber alle Karten.'],
  log:['Request-Log','Einzelrequests mit Status, Latenz, Tokens und Preview.']
};
const PRESETS=[
  {cat:'Baselines',id:'lat',name:'Latenz-Baseline',build:b=>[{...b,name:'Latency-Baseline',totalRequests:60,maxParallel:1,delayMs:120,stream:false,temperature:0.1}]},
  {cat:'Baselines',id:'ttft',name:'TTFB-Streaming',build:b=>[{...b,name:'TTFB-Stream',totalRequests:80,maxParallel:2,delayMs:80,stream:true,temperature:0.2}]},
  {cat:'Durchsatz',id:'thr',name:'Max Durchsatz',build:b=>[{...b,name:'Throughput',totalRequests:0,maxParallel:96,delayMs:0,stream:false}]},
  {cat:'Durchsatz',id:'scan',name:'Parallel Scan',build:b=>[1,2,4,8,16,32].map((p,i)=>({...b,name:`Parallel-${p}`,totalRequests:120,maxParallel:p,delayMs:p<=4?45:0,batch:i+1}))},
  {cat:'Vergleich',id:'prio',name:'Prioritaets Paar',build:b=>[{...b,name:'Prio-0',priority:0,totalRequests:200,maxParallel:10,batch:1},{...b,name:'Prio-200',priority:200,totalRequests:200,maxParallel:10,batch:2}]}
];
const toNum=(v,f=0)=>{const n=Number(v);return Number.isFinite(n)?n:f};
const avg=a=>a.length?a.reduce((s,x)=>s+x,0)/a.length:0;
const pct=(a,p)=>{if(!a.length)return 0;const s=[...a].sort((x,y)=>x-y);const i=Math.min(s.length-1,Math.max(0,Math.ceil(s.length*p)-1));return s[i]};
const ms=v=>!Number.isFinite(v)||v<0?'-':(v<1000?`${Math.round(v)} ms`:`${(v/1000).toFixed(2)} s`);
const n=(v,d=1)=>Number.isFinite(v)?Number(v).toFixed(d):'-';
const i=v=>Number.isFinite(v)?String(Math.round(v)):'-';
const pc=(v,d=1)=>Number.isFinite(v)?`${Number(v).toFixed(d)} %`:'-';
const dur=s=>!Number.isFinite(s)||s<0?'0 s':(s<60?`${s.toFixed(1)} s`:`${Math.floor(s/60)} m ${String(Math.floor(s%60)).padStart(2,'0')} s`);
const jload=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
const jsave=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>`${Date.now()}_${Math.random().toString(36).slice(2,10)}`;
const normBase=raw=>{const t=String(raw||'').trim();if(!t)return'';let u=t.replace(/\/+$/,'');if(!/^https?:\/\//i.test(u))u='http://'+u.replace(/^\/+/,'');u=u.replace(/\/v1$/i,'');return u};
const join=(b,p)=>`${b.replace(/\/+$/,'')}/${p.replace(/^\/+/,'')}`;
const mkCard=(b={})=>({id:b.id||uid(),name:b.name||'Neuer Lauf',apiBaseUrl:normBase(b.apiBaseUrl||'http://localhost:8090/v1')||'http://localhost:8090',apiKey:b.apiKey||'',model:b.model||'',systemPrompt:b.systemPrompt||'',prompt:b.prompt||'Erzeuge eine knappe technische Antwort in einem Satz.',totalRequests:b.totalRequests??50,maxParallel:b.maxParallel??2,delayMs:b.delayMs??40,maxTokens:b.maxTokens??128,temperature:b.temperature??0.7,priority:b.priority??0,stream:b.stream??false,sslVerify:b.sslVerify??true,batch:b.batch??1});
const cleanCard=c=>({id:c.id,name:c.name,apiBaseUrl:normBase(c.apiBaseUrl),apiKey:c.apiKey,model:c.model,systemPrompt:c.systemPrompt,prompt:c.prompt,totalRequests:toNum(c.totalRequests,0),maxParallel:toNum(c.maxParallel,0),delayMs:toNum(c.delayMs,0),maxTokens:toNum(c.maxTokens,128),temperature:toNum(c.temperature,.7),priority:toNum(c.priority,0),stream:!!c.stream,sslVerify:!!c.sslVerify,batch:toNum(c.batch,1)});
const mkRt=()=>({running:false,sent:0,ok:0,fail:0,inflight:0,pTok:0,cTok:0,tTok:0,lats:[],ttfbs:[],tps:[],recent:[],errs:[],start:0,end:0,lastDispatch:0,dispatch:[]});
function parseUsage(text){try{const d=JSON.parse(text),u=d?.usage||{};return{p:Number(u.prompt_tokens||0),c:Number(u.completion_tokens||0),txt:d?.choices?.[0]?.message?.content||''}}catch{return{p:0,c:0,txt:''}}}
class WS{
  constructor(on){this.on=on;this.sock=null;this.seq=0;this.pending=new Map();this.ready=false;this.connP=null;this.reTimer=null;this.err=''}
  st(r,e=''){this.ready=r;this.err=e;if(this.on)this.on({ready:r,lastError:e})}
  connect(){if(this.sock&&(this.sock.readyState===0||this.sock.readyState===1))return this.connP||Promise.resolve(true);const proto=location.protocol==='https:'?'wss:':'ws:';const url=`${proto}//${location.host}/ws`;this.connP=new Promise(res=>{const s=new WebSocket(url);this.sock=s;s.onopen=()=>{this.st(true,'');res(true)};s.onclose=()=>{this.st(false,this.err||'WebSocket getrennt');clearTimeout(this.reTimer);this.reTimer=setTimeout(()=>this.connect(),2000)};s.onerror=()=>{this.err='WebSocket Fehler';this.st(false,this.err)};s.onmessage=ev=>{let m;try{m=JSON.parse(ev.data)}catch{return}const p=this.pending.get(String(m.id||''));if(!p)return;if(m.type==='error'){this.pending.delete(String(m.id));p.reject(new Error(m.error||'Proxy-Fehler'));return}if(p.stream){if(m.type==='stream_start'){p.status=m.status;p.headers=m.headers||{};p.onStart&&p.onStart(m);return}if(m.type==='stream_chunk'){const d=String(m.data||'');p.buf+=d;p.onChunk&&p.onChunk(d);return}if(m.type==='stream_end'){this.pending.delete(String(m.id));p.onEnd&&p.onEnd();p.resolve({status:p.status||0,headers:p.headers||{},body:p.buf});return}}if(m.type==='response'){this.pending.delete(String(m.id));p.resolve({status:Number(m.status||0),headers:m.headers||{},body:String(m.body||'')})}}});return this.connP}
  async ensure(){if(this.ready&&this.sock&&this.sock.readyState===1)return true;await this.connect();if(!this.ready)throw new Error('WebSocket nicht verbunden');return true}
  async req({url,method='POST',headers={},body='',stream=false,onStart,onChunk,onEnd}){await this.ensure();if(!this.sock||this.sock.readyState!==1)throw new Error('WebSocket nicht bereit');const id=String(++this.seq);return new Promise((resolve,reject)=>{this.pending.set(id,{resolve,reject,stream,buf:'',status:0,headers:{},onStart,onChunk,onEnd});this.sock.send(JSON.stringify({id,url,method,headers,body,stream}));setTimeout(()=>{const p=this.pending.get(id);if(p){this.pending.delete(id);reject(new Error('Proxy Timeout'))}},300000)})}
  close(){clearTimeout(this.reTimer);if(this.sock){this.sock.close();this.sock=null}for(const [id,p]of this.pending.entries()){p.reject(new Error('Transport geschlossen'));this.pending.delete(id)}}
}
function Help({id,open,setOpen}){const e=HELP[id];if(!e)return null;const o=open===id;return <span className="help-wrap"><button className="help" type="button" onClick={ev=>{ev.preventDefault();ev.stopPropagation();setOpen(o?null:id)}}>?</button>{o?<div className="help-pop" onClick={ev=>ev.stopPropagation()}><h4>{e[0]}</h4><p>{e[1]}</p></div>:null}</span>}
function L({t,id,open,setOpen}){return <div className="lab"><span>{t}</span><Help id={id} open={open} setOpen={setOpen}/></div>}
function App(){
  const initCards=useMemo(()=>{const s=jload(SK.cards,[]);return Array.isArray(s)&&s.length?s.map(mkCard):[mkCard()]},[]);
  const [cards,setCards]=useState(initCards);
  const [profiles,setProfiles]=useState(()=>jload(SK.profiles,{}));
  const [mcfg,setMcfg]=useState(()=>jload(SK.mcfg,{}));
  const [activeCard,setActiveCard]=useState(initCards[0]?.id||'');
  const [preset,setPreset]=useState('');
  const [selProf,setSelProf]=useState('');
  const [selCfg,setSelCfg]=useState('');
  const [modelOpts,setModelOpts]=useState({});
  const [modelLoad,setModelLoad]=useState({});
  const [log,setLog]=useState([]);
  const [elog,setElog]=useState([]);
  const [toasts,setToasts]=useState([]);
  const [autoScroll,setAutoScroll]=useState(true);
  const [logFilter,setLogFilter]=useState('all');
  const [openHelp,setOpenHelp]=useState(null);
  const [wsSt,setWsSt]=useState({ready:false,lastError:''});
  const [tick,setTick]=useState(Date.now());
  const [sort,setSort]=useState({k:'name',asc:true});
  const logRef=useRef(null);
  const fileRef=useRef(null);
  const wsRef=useRef(null);
  const rtRef=useRef(new Map());
  const runRef=useRef(new Map());
  const cardsRef=useRef(cards);

  useEffect(()=>{cardsRef.current=cards;jsave(SK.cards,cards.map(cleanCard))},[cards]);
  useEffect(()=>jsave(SK.profiles,profiles),[profiles]);
  useEffect(()=>jsave(SK.mcfg,mcfg),[mcfg]);
  useEffect(()=>{const fn=()=>setOpenHelp(null);document.addEventListener('click',fn);return()=>document.removeEventListener('click',fn)},[]);
  useEffect(()=>{const iv=setInterval(()=>setTick(Date.now()),260);return()=>clearInterval(iv)},[]);
  useEffect(()=>{wsRef.current=new WS(s=>setWsSt(s));wsRef.current.ensure().catch(()=>{});return()=>wsRef.current?.close()},[]);
  useEffect(()=>{if(!autoScroll||!logRef.current)return;logRef.current.scrollTop=0},[log,autoScroll]);
  useEffect(()=>{cards.forEach(c=>{if(!rtRef.current.has(c.id))rtRef.current.set(c.id,mkRt())});const ids=new Set(cards.map(c=>c.id));for(const id of Array.from(rtRef.current.keys()))if(!ids.has(id)){runRef.current.delete(id);rtRef.current.delete(id)}},[cards]);
  useEffect(()=>{const h=ev=>{if(ev.ctrlKey&&ev.key.toLowerCase()==='s'){ev.preventDefault();startAll()}if(ev.ctrlKey&&ev.key.toLowerCase()==='x'){ev.preventDefault();stopAll()}};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[cards]);

  const toast=useCallback((msg,kind='info')=>{const id=uid();setToasts(p=>[{id,msg,kind},...p].slice(0,6));setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),5200)},[]);
  const evlog=useCallback((type,payload)=>setElog(p=>[{id:uid(),ts:new Date().toISOString(),type,payload},...p].slice(0,25000)),[]);
  const rt=useCallback(id=>{let r=rtRef.current.get(id);if(!r){r=mkRt();rtRef.current.set(id,r)}return r},[]);
  const up=useCallback((id,patch)=>setCards(prev=>prev.map(c=>c.id===id?{...c,...patch}:c)),[]);

  const stopCard=useCallback((id,reason='manuell')=>{runRef.current.delete(id);const r=rt(id);r.running=false;r.end=Date.now();evlog('card_stop',{id,reason,sent:r.sent,ok:r.ok,fail:r.fail})},[evlog,rt]);
  const resetCard=useCallback(id=>{stopCard(id,'reset');rtRef.current.set(id,mkRt());evlog('card_reset',{id})},[evlog,stopCard]);
  const resetAll=useCallback(()=>{for(const c of cardsRef.current){stopCard(c.id,'global_reset');rtRef.current.set(c.id,mkRt())}setLog([]);setElog([]);toast('Alles wurde zurueckgesetzt','warn')},[stopCard,toast]);

  const execReq=useCallback(async(card,h)=>{
    const base=normBase(card.apiBaseUrl);if(!base)throw new Error('API URL fehlt');
    const url=join(base,'/v1/chat/completions');
    const key=String(card.apiKey||'').trim();
    const headers={'Content-Type':'application/json'};if(key)headers.Authorization=`Bearer ${key}`;
    const msgs=[];if(String(card.systemPrompt||'').trim())msgs.push({role:'system',content:String(card.systemPrompt||'')});msgs.push({role:'user',content:String(card.prompt||'')});
    const body=JSON.stringify({model:String(card.model||'').trim(),messages:msgs,max_tokens:toNum(card.maxTokens,128),temperature:toNum(card.temperature,.7),stream:!!card.stream,priority:toNum(card.priority,0)});
    if(!card.sslVerify&&/^https:\/\//i.test(url)&&!card.stream){
      const resp=await fetch('/proxy-insecure',{method:'POST',headers:{'Content-Type':'application/json','X-Target-URL':url,...(key?{Authorization:`Bearer ${key}`}:{})},body});
      return{status:resp.status,headers:Object.fromEntries(resp.headers.entries()),body:await resp.text()};
    }
    return wsRef.current.req({url,method:'POST',headers,body,stream:!!card.stream,onStart:h?.onStart,onChunk:h?.onChunk,onEnd:h?.onEnd});
  },[]);

  const oneReq=useCallback(async(id,card,token,seq)=>{
    const r=rt(id),t0=performance.now(),iso=new Date().toISOString();
    let first=null,buf='',txt='',pTok=0,cTok=0,status=0;
    const parse=chunk=>{buf+=chunk;const lines=buf.split(/\r?\n/);buf=lines.pop()||'';for(const raw of lines){const l=raw.trim();if(!l||!l.startsWith('data:'))continue;const d=l.slice(5).trim();if(!d||d==='[DONE]')continue;try{const j=JSON.parse(d),delta=j?.choices?.[0]?.delta?.content;if(delta)txt+=String(delta);if(j?.usage){pTok=Number(j.usage.prompt_tokens||pTok||0);cTok=Number(j.usage.completion_tokens||cTok||0)}}catch{}}};
    try{
      const resp=await execReq(card,{onChunk:c=>{if(first===null)first=performance.now();parse(c)}});status=resp.status;const lat=performance.now()-t0,ttfb=first!==null?first-t0:null;
      if(status>=200&&status<300){if(!card.stream){const pu=parseUsage(resp.body);pTok=pu.p;cTok=pu.c;txt=pu.txt||txt}const tTok=pTok+cTok,tps=lat>0?(cTok/(lat/1000)):0;
        if(runRef.current.get(id)===token){r.ok++;r.pTok+=pTok;r.cTok+=cTok;r.tTok+=tTok;r.lats.push(lat);if(Number.isFinite(ttfb))r.ttfbs.push(ttfb);if(Number.isFinite(tps)&&tps>0)r.tps.push(tps);r.recent.push({ok:true,lat});if(r.recent.length>80)r.recent.shift()}
        setLog(prev=>[{id:uid(),ts:iso,cardId:id,card:card.name,model:card.model,ok:true,status,lat,ttfb,pTok,cTok,tTok,tps,prio:card.priority,batch:card.batch,preview:String(txt||'').slice(0,220),seq},...prev].slice(0,1600));
      }else{const msg=`HTTP ${status}`;if(runRef.current.get(id)===token){r.fail++;r.recent.push({ok:false,lat});r.errs.unshift({ts:iso,msg,status});r.errs=r.errs.slice(0,60);if(r.recent.length>80)r.recent.shift()}
        setLog(prev=>[{id:uid(),ts:iso,cardId:id,card:card.name,model:card.model,ok:false,status,lat,ttfb:null,pTok:0,cTok:0,tTok:0,tps:0,prio:card.priority,batch:card.batch,preview:String(resp.body||'').slice(0,220),seq},...prev].slice(0,1600));}
    }catch(e){const lat=performance.now()-t0,msg=e?.message||String(e)||'Unbekannter Fehler';if(runRef.current.get(id)===token){r.fail++;r.recent.push({ok:false,lat});r.errs.unshift({ts:iso,msg,status:0});r.errs=r.errs.slice(0,60);if(r.recent.length>80)r.recent.shift()}
      setLog(prev=>[{id:uid(),ts:iso,cardId:id,card:card.name,model:card.model,ok:false,status:0,lat,ttfb:null,pTok:0,cTok:0,tTok:0,tps:0,prio:card.priority,batch:card.batch,preview:msg.slice(0,220),seq},...prev].slice(0,1600));
    }finally{r.inflight=Math.max(0,r.inflight-1)}
  },[execReq,rt]);

  const runLoop=useCallback(async(id,token)=>{
    const r=rt(id);
    while(runRef.current.get(id)===token){
      const card=cardsRef.current.find(c=>c.id===id);if(!card)break;
      if(!String(card.model||'').trim()){stopCard(id,'modell_fehlt');toast(`${card.name}: Modell fehlt`,'error');break}
      const total=Math.max(0,toNum(card.totalRequests,0)),maxPar=Math.max(0,toNum(card.maxParallel,0)),delay=Math.max(0,toNum(card.delayMs,0));
      if(total>0&&r.sent>=total)break;
      if(maxPar>0&&r.inflight>=maxPar){await new Promise(x=>setTimeout(x,14));continue}
      r.sent++;r.inflight++;const now=Date.now();if(r.lastDispatch>0){r.dispatch.push(now-r.lastDispatch);if(r.dispatch.length>3000)r.dispatch.shift()}r.lastDispatch=now;
      void oneReq(id,{...card},token,r.sent);
      await new Promise(x=>setTimeout(x,delay>0?delay:0));
    }
    while(runRef.current.get(id)===token&&rt(id).inflight>0)await new Promise(x=>setTimeout(x,16));
    if(runRef.current.get(id)===token){runRef.current.delete(id);r.running=false;r.end=Date.now();const label=cardsRef.current.find(c=>c.id===id)?.name||id;toast(`${label}: Lauf beendet (OK ${r.ok} / ${r.sent})`,r.fail>0?'warn':'success');evlog('card_finished',{id,sent:r.sent,ok:r.ok,fail:r.fail,elapsed_s:r.start>0?((r.end-r.start)/1000):0})}
  },[evlog,oneReq,rt,stopCard,toast]);

  const startCard=useCallback(id=>{const card=cardsRef.current.find(c=>c.id===id);if(!card)return;if(!String(card.model||'').trim()){toast(`${card.name}: bitte Modell eintragen`,'error');return}const r=rt(id);if(r.running)return;
    Object.assign(r,{running:true,sent:0,ok:0,fail:0,inflight:0,pTok:0,cTok:0,tTok:0,lats:[],ttfbs:[],tps:[],recent:[],errs:[],start:Date.now(),end:0,lastDispatch:0,dispatch:[]});
    const tok=uid();runRef.current.set(id,tok);evlog('card_start',{id,name:card.name,model:card.model,totalRequests:card.totalRequests,maxParallel:card.maxParallel,delayMs:card.delayMs,stream:card.stream});void runLoop(id,tok)
  },[evlog,rt,runLoop,toast]);

  const startAll=useCallback(()=>{for(const c of cardsRef.current)startCard(c.id)},[startCard]);
  const stopAll=useCallback(()=>{for(const c of cardsRef.current)stopCard(c.id,'global_stop');toast('Alle aktiven Runs gestoppt','warn')},[stopCard,toast]);
  const clearLog=useCallback(()=>{setLog([]);toast('Request-Log wurde geleert','info')},[toast]);

  const addCard=useCallback(()=>{const b=cardsRef.current[0]||mkCard();const c=mkCard({apiBaseUrl:b.apiBaseUrl,apiKey:b.apiKey,model:b.model,systemPrompt:b.systemPrompt,prompt:b.prompt,name:`Lauf ${cardsRef.current.length+1}`});setCards(p=>[...p,c]);setActiveCard(c.id)},[]);
  const dupCard=useCallback(id=>{const c=cardsRef.current.find(x=>x.id===id);if(!c)return;const d=mkCard({...c,name:`${c.name} Kopie`});setCards(p=>[...p,d]);setActiveCard(d.id)},[]);
  const delCard=useCallback(id=>{stopCard(id,'remove');setCards(p=>{const n=p.filter(c=>c.id!==id);if(n.length){setActiveCard(a=>n.some(c=>c.id===a)?a:n[0].id);return n}const one=mkCard({name:'Lauf 1'});setActiveCard(one.id);return[one]})},[stopCard]);
  const applyPreset=useCallback(()=>{if(!preset){toast('Bitte Preset auswaehlen','error');return}const p=PRESETS.find(x=>x.id===preset);if(!p){toast('Preset nicht gefunden','error');return}const b=cardsRef.current[0]||mkCard();for(const o of cardsRef.current)stopCard(o.id,'preset_replace');const n=p.build({...b}).map(mkCard);setCards(n);setActiveCard(n[0]?.id||'');toast(`Preset angewendet: ${p.name}`,'success');evlog('preset_apply',{preset,card_count:n.length})},[evlog,preset,stopCard,toast]);

  const saveProfile=useCallback(()=>{const raw=window.prompt('Profilname eingeben:',selProf||'');const name=String(raw||'').trim();if(!name)return;const snap=cardsRef.current.map(cleanCard);setProfiles(p=>({...p,[name]:{updated_at:new Date().toISOString(),cards:snap}}));setSelProf(name);toast(`Profil gespeichert: ${name}`,'success')},[selProf,toast]);
  const loadProfile=useCallback(()=>{const p=profiles[selProf];if(!p||!Array.isArray(p.cards)||!p.cards.length){toast('Profil ist leer oder ungueltig','error');return}for(const o of cardsRef.current)stopCard(o.id,'profile_replace');const n=p.cards.map(mkCard);setCards(n);setActiveCard(n[0]?.id||'');toast(`Profil geladen: ${selProf}`,'success');evlog('profile_load',{name:selProf,card_count:n.length})},[evlog,profiles,selProf,stopCard,toast]);
  const delProfile=useCallback(()=>{if(!selProf){toast('Kein Profil ausgewaehlt','error');return}if(!window.confirm(`Profil '${selProf}' wirklich loeschen?`))return;setProfiles(p=>{const n={...p};delete n[selProf];return n});setSelProf('');toast('Profil geloescht','warn')},[selProf,toast]);

  const cfgFile=useCallback(name=>`model_${String(name).replace(/[^a-zA-Z0-9_\-.]/g,'_')}.json`,[]);
  const refreshCfg=useCallback(async()=>{try{const lr=await fetch(`/data/?${Date.now()}`);if(!lr.ok)throw new Error();const list=await lr.json();const files=Array.isArray(list)?list.filter(x=>String(x?.name||'').startsWith('model_')&&String(x?.name||'').endsWith('.json')):[];const out={};await Promise.all(files.map(async f=>{try{const r=await fetch(`/data/${f.name}?${Date.now()}`);if(!r.ok)return;const b=await r.json();const fb=String(f.name).replace(/^model_/,'').replace(/\.json$/,'');const nm=String(b?.name||fb).trim();if(!nm)return;const cfg=b?.config?b.config:b;out[nm]={name:nm,updated_at:b?.updated_at||new Date().toISOString(),config:cleanCard(mkCard(cfg))}}catch{}}));setMcfg(out);toast(`Modell-Konfigurationen aktualisiert (${Object.keys(out).length})`,'info')}catch{toast('Model-Konfigurationen konnten nicht vom Server gelesen werden','warn')}},[toast]);
  useEffect(()=>{refreshCfg()},[refreshCfg]);

  const saveCfg=useCallback(async()=>{const c=cardsRef.current.find(x=>x.id===activeCard);if(!c){toast('Bitte aktive Karte waehlen','error');return}const raw=window.prompt('Name fuer Modell-Konfiguration:',String(c.model||c.name||'modell').trim());const name=String(raw||'').trim();if(!name)return;const payload={name,updated_at:new Date().toISOString(),config:cleanCard(c)};try{const r=await fetch(`/data/${cfgFile(name)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload,null,2)});if(!r.ok)throw new Error();setMcfg(p=>({...p,[name]:payload}));setSelCfg(name);toast(`Modell-Konfiguration gespeichert: ${name}`,'success')}catch{setMcfg(p=>({...p,[name]:payload}));toast('Serverspeicherung fehlgeschlagen, lokal gespeichert','warn')}},[activeCard,cfgFile,toast]);
  const loadCfg=useCallback(()=>{const e=mcfg[selCfg];if(!e?.config){toast('Bitte gueltige Modell-Konfiguration auswaehlen','error');return}const id=activeCard||cardsRef.current[0]?.id;if(!id)return;stopCard(id,'cfg_load');const m=mkCard({...e.config,id,name:cardsRef.current.find(c=>c.id===id)?.name||e.config.name||'Konfig-Lauf'});setCards(p=>p.map(c=>c.id===id?m:c));toast(`Modell-Konfiguration geladen in Karte ${m.name}`,'success')},[activeCard,mcfg,selCfg,stopCard,toast]);
  const delCfg=useCallback(async()=>{const name=selCfg;if(!name){toast('Keine Modell-Konfiguration ausgewaehlt','error');return}if(!window.confirm(`Modell-Konfiguration '${name}' wirklich loeschen?`))return;try{await fetch(`/data/${cfgFile(name)}`,{method:'DELETE'})}catch{}setMcfg(p=>{const n={...p};delete n[name];return n});setSelCfg('');toast('Modell-Konfiguration geloescht','warn')},[cfgFile,selCfg,toast]);

  const loadModels=useCallback(async id=>{const c=cardsRef.current.find(x=>x.id===id);if(!c)return;if(!String(c.apiBaseUrl||'').trim()){toast(`${c.name}: API URL fehlt`,'error');return}setModelLoad(p=>({...p,[id]:true}));
    try{const base=normBase(c.apiBaseUrl),url=join(base,'/v1/models');const headers={};const key=String(c.apiKey||'').trim();if(key)headers.Authorization=`Bearer ${key}`;let res;
      if(!c.sslVerify&&/^https:\/\//i.test(url)){const r=await fetch('/proxy-insecure',{method:'GET',headers:{'X-Target-URL':url,...(headers.Authorization?{Authorization:headers.Authorization}:{})}});res={status:r.status,body:await r.text()}}
      else res=await wsRef.current.req({url,method:'GET',headers,body:'',stream:false});
      if(res.status<200||res.status>=300)throw new Error();let d;try{d=JSON.parse(res.body)}catch{d={data:[]}}const ids=Array.isArray(d?.data)?d.data.map(m=>String(m?.id||'').trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b,'de')):[];
      setModelOpts(p=>({...p,[id]:ids}));if(ids.length&&!String(c.model||'').trim())up(id,{model:ids[0]});toast(`${c.name}: ${ids.length} Modelle geladen`,'success')
    }catch{toast(`${c.name}: Modellliste konnte nicht geladen werden`,'error')}finally{setModelLoad(p=>({...p,[id]:false}))}
  },[toast,up]);

  const exportSession=useCallback(()=>{const payload={exported_at:new Date().toISOString(),version:4,cards:cardsRef.current.map(cleanCard),profiles,modelConfigs:mcfg,log_count:log.length,event_count:elog.length};const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`load-tester-session-${Date.now()}.json`;a.click();URL.revokeObjectURL(url)},[elog.length,log.length,mcfg,profiles]);
  const importSession=useCallback(()=>fileRef.current&&fileRef.current.click(),[]);
  const onImport=useCallback(async ev=>{const f=ev.target.files?.[0];ev.target.value='';if(!f)return;try{const t=await f.text(),p=JSON.parse(t);const inCards=Array.isArray(p.cards)?p.cards.map(mkCard):[];if(inCards.length){for(const o of cardsRef.current)stopCard(o.id,'session_import');setCards(inCards);setActiveCard(inCards[0]?.id||'')}if(p.profiles&&typeof p.profiles==='object')setProfiles(p.profiles);if(p.modelConfigs&&typeof p.modelConfigs==='object')setMcfg(p.modelConfigs);toast('Session importiert','success')}catch{toast('Import-Datei ist ungueltig','error')}},[stopCard,toast]);
  const copySummary=useCallback(async()=>{const lines=[`Exportzeit: ${new Date().toISOString()}`];for(const c of cardsRef.current){const r=rt(c.id);const el=r.start?((r.running?tick:(r.end||tick))-r.start)/1000:0;const rate=r.sent>0?(r.ok/r.sent)*100:0;lines.push(`${c.name}: sent=${r.sent}, ok=${r.ok}, fail=${r.fail}, rate=${rate.toFixed(1)}%, avg=${ms(avg(r.lats))}, p95=${ms(pct(r.lats,.95))}, elapsed=${dur(el)}`)}try{await navigator.clipboard.writeText(lines.join('\n'));toast('Zusammenfassung in Clipboard kopiert','success')}catch{toast('Clipboard konnte nicht beschrieben werden','error')}},[rt,tick,toast]);
  const exportElog=useCallback(()=>{const blob=new Blob([JSON.stringify({exported_at:new Date().toISOString(),events:elog},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`load-tester-events-${Date.now()}.json`;a.click();URL.revokeObjectURL(url)},[elog]);

  const profNames=useMemo(()=>Object.keys(profiles).sort((a,b)=>a.localeCompare(b,'de')),[profiles]);
  const cfgNames=useMemo(()=>Object.keys(mcfg).sort((a,b)=>a.localeCompare(b,'de')),[mcfg]);
  const ordCards=useMemo(()=>[...cards].sort((a,b)=>`${a.name||''} ${a.model||''}`.toLowerCase().localeCompare(`${b.name||''} ${b.model||''}`.toLowerCase(),'de')),[cards]);

  const sums=useMemo(()=>cards.map(c=>{const r=rt(c.id),run=r.running,el=r.start?((run?tick:(r.end||tick))-r.start)/1000:0,rate=r.sent>0?(r.ok/r.sent)*100:0,rps=el>0?r.sent/el:0,tps=el>0?r.tTok/el:0,al=avg(r.lats),p95=pct(r.lats,.95),tt=avg(r.ttfbs),ctps=avg(r.tps),davg=avg(r.dispatch),prog=toNum(c.totalRequests,0)>0?Math.max(0,Math.min(100,(r.sent/Math.max(1,toNum(c.totalRequests,1)))*100)):(run?100:0);return{id:c.id,name:c.name,model:c.model,run,el,rate,rps,tps,al,p95,tt,ctps,davg,prog,sent:r.sent,ok:r.ok,fail:r.fail,inflight:r.inflight,pTok:r.pTok,cTok:r.cTok,tTok:r.tTok,errs:r.errs,recent:r.recent,total:toNum(c.totalRequests,0)}}),[cards,rt,tick]);
  const g=useMemo(()=>{const o={cards:sums.length,running:0,sent:0,ok:0,fail:0,inflight:0,pTok:0,cTok:0,tTok:0,el:0,avg:0,p95:0,ttfb:0,rps:0,tps:0,rate:0,errRate:0};const l=[],t=[];for(const s of sums){if(s.run)o.running++;o.sent+=s.sent;o.ok+=s.ok;o.fail+=s.fail;o.inflight+=s.inflight;o.pTok+=s.pTok;o.cTok+=s.cTok;o.tTok+=s.tTok;o.el=Math.max(o.el,s.el);const r=rt(s.id);l.push(...r.lats);t.push(...r.ttfbs)}o.avg=avg(l);o.p95=pct(l,.95);o.ttfb=avg(t);o.rps=o.el>0?o.sent/o.el:0;o.tps=o.el>0?o.tTok/o.el:0;o.rate=o.sent>0?(o.ok/o.sent)*100:0;o.errRate=o.sent>0?(o.fail/o.sent)*100:0;return o},[rt,sums]);
  const sorted=useMemo(()=>{const a=[...sums],{k,asc}=sort;a.sort((x,y)=>{let vx=x[k],vy=y[k];if(typeof vx==='string'){const c=String(vx).localeCompare(String(vy),'de');return asc?c:-c}vx=Number(vx||0);vy=Number(vy||0);return asc?(vx-vy):(vy-vx)});return a},[sort,sums]);
  const fl=useMemo(()=>logFilter==='all'?log:(logFilter==='ok'?log.filter(r=>r.ok):(logFilter==='fail'?log.filter(r=>!r.ok):log.filter(r=>Number(r.ttfb)>0))),[log,logFilter]);
  const latHist=useMemo(()=>{const vals=[];for(const s of sums)vals.push(...rt(s.id).lats);const max=Math.max(g.p95*1.1,1,...vals);const b=Array(12).fill(0);for(const v of vals){const idx=Math.min(11,Math.floor((v/max)*12));b[idx]++}return{b,max}},[g.p95,rt,sums]);
  const tokHist=useMemo(()=>{const vals=log.slice(0,900).map(r=>Number(r.cTok||0)).filter(v=>v>0);const max=Math.max(1,...vals);const b=Array(12).fill(0);for(const v of vals){const idx=Math.min(11,Math.floor((v/max)*12));b[idx]++}return{b,max}},[log]);
  return <div className="wrap" onClick={()=>setOpenHelp(null)}>
    <div className="panel">
      <div className="head">
        <div><h1 className="title">LLM Load Tester</h1><div className="sub">React-Frontend im HPE-Design mit klaren Akzenten, sortierten Dropdowns und ausfuehrlichen Hilfetexten</div></div>
        <div className="badges">
          <span className={`badge ${wsSt.ready?'ok':'err'}`}>WebSocket: {wsSt.ready?'verbunden':'getrennt'}</span>
          <span className="badge">Lokalzeit: {new Date(tick).toLocaleTimeString('de-DE',{hour12:false})}</span>
          <span className="badge">Ctrl+S Start Alle</span>
          <span className="badge">Ctrl+X Stop Alle</span>
        </div>
      </div>
      <div className="tools">
        <div className="box">
          <h2>Runs und Presets</h2>
          <div className="row">
            <div className="field s7" onClick={ev=>ev.stopPropagation()}><L t="Preset" id="preset" open={openHelp} setOpen={setOpenHelp}/><select value={preset} onChange={ev=>setPreset(ev.target.value)}><option value="">Preset auswaehlen</option>{['Baselines','Durchsatz','Vergleich'].map(cat=><optgroup key={cat} label={cat}>{PRESETS.filter(p=>p.cat===cat).sort((a,b)=>a.name.localeCompare(b.name,'de')).map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</optgroup>)}</select></div>
            <div className="s5" style={{display:'grid',gap:6,alignContent:'end'}}><button className="primary" onClick={applyPreset}>Preset anwenden</button><button onClick={addCard}>Karte hinzufuegen</button></div>
          </div>
          <div className="row"><div className="s4"><button className="success" onClick={startAll}>Alle starten</button></div><div className="s4"><button className="danger" onClick={stopAll}>Alle stoppen</button></div><div className="s4"><button onClick={resetAll}>Alles resetten</button></div></div>
        </div>

        <div className="box">
          <h2>Profile und Modell-Konfig</h2>
          <div className="row" onClick={ev=>ev.stopPropagation()}>
            <div className="field s8"><L t="Benchmark-Profil" id="profile" open={openHelp} setOpen={setOpenHelp}/><select value={selProf} onChange={ev=>setSelProf(ev.target.value)}><option value="">Profil auswaehlen</option>{profNames.map(nm=><option key={nm} value={nm}>{nm}</option>)}</select></div>
            <div className="s4" style={{display:'grid',gap:6,alignContent:'end'}}><button onClick={saveProfile}>Profil speichern</button><button onClick={loadProfile} disabled={!selProf}>Profil laden</button></div>
          </div>
          <div className="row"><div className="s4"><button onClick={delProfile} disabled={!selProf}>Profil loeschen</button></div><div className="field s8" onClick={ev=>ev.stopPropagation()}><L t="Aktive Karte fuer Modell-Konfig" id="mcfg" open={openHelp} setOpen={setOpenHelp}/><select value={activeCard} onChange={ev=>setActiveCard(ev.target.value)}>{ordCards.map(c=><option key={c.id} value={c.id}>{c.name||c.model||c.id}</option>)}</select></div></div>
          <div className="row" onClick={ev=>ev.stopPropagation()}>
            <div className="field s8"><select value={selCfg} onChange={ev=>setSelCfg(ev.target.value)}><option value="">Modell-Konfiguration auswaehlen</option>{cfgNames.map(nm=><option key={nm} value={nm}>{nm}</option>)}</select></div>
            <div className="s4" style={{display:'grid',gap:6,alignContent:'end'}}><button onClick={refreshCfg}>Aktualisieren</button><button onClick={saveCfg}>Karte speichern</button></div>
          </div>
          <div className="row"><div className="s4"><button onClick={loadCfg} disabled={!selCfg}>Laden</button></div><div className="s4"><button onClick={delCfg} disabled={!selCfg}>Loeschen</button></div><div className="s4"><button onClick={copySummary}>Kurzbericht kopieren</button></div></div>
        </div>

        <div className="box">
          <h2>Session und Logs</h2>
          <div className="row">
            <div className="s4"><button onClick={exportSession}>Session Export</button></div>
            <div className="s4"><button onClick={importSession}>Session Import</button></div>
            <div className="s4"><button onClick={clearLog}>Request-Log leeren</button></div>
            <div className="s4"><button onClick={exportElog}>Event-Log Export</button></div>
            <div className="s4"><button onClick={()=>setElog([])}>Event-Log leeren</button></div>
            <div className="s4"><button onClick={()=>wsRef.current?.ensure().catch(()=>{})}>WS neu verbinden</button></div>
          </div>
          <input ref={fileRef} type="file" accept=".json" style={{display:'none'}} onChange={onImport}/>
          <div className="small">Ablauf: Karte konfigurieren, optional Modelle laden, dann starten. Fuer vergleichbare Messungen Prompt/Modell konstant halten und nur Lastparameter variieren.</div>
        </div>
      </div>
    </div>

    <div className="panel cards">
      {cards.map(card=>{const s=sums.find(x=>x.id===card.id),rc=s?.recent||[],mx=Math.max(1,...rc.map(x=>x.lat||0));return <div key={card.id} className={`card ${s?.run?'run':(s?.sent>0?'done':'')}`} onClick={ev=>ev.stopPropagation()}>
        <div className="card-h">
          <div className={`dot ${s?.run?'run':(s?.sent>0?'done':'')}`}/>
          <div className="c-t"><div className="m">{card.name||card.model||'Unbenannt'}</div><div className="s">{card.model||'Kein Modell gesetzt'}</div></div>
          <div className="c-a"><button className="success" onClick={()=>startCard(card.id)} disabled={s?.run}>Start</button><button className="danger" onClick={()=>stopCard(card.id)} disabled={!s?.run}>Stop</button><button onClick={()=>resetCard(card.id)}>Reset</button><button onClick={()=>dupCard(card.id)}>Duplizieren</button><button onClick={()=>delCard(card.id)} disabled={cards.length<=1}>Loeschen</button></div>
        </div>
        <div className="card-b">
          <div className="row"><div className="field s5"><L t="Name" id="mcfg" open={openHelp} setOpen={setOpenHelp}/><input value={card.name} onChange={ev=>up(card.id,{name:ev.target.value})}/></div><div className="field s7"><L t="API Base URL" id="url" open={openHelp} setOpen={setOpenHelp}/><input value={card.apiBaseUrl} onChange={ev=>up(card.id,{apiBaseUrl:ev.target.value})} onBlur={()=>up(card.id,{apiBaseUrl:normBase(card.apiBaseUrl)})} placeholder="http://localhost:8090/v1"/></div></div>
          <div className="row"><div className="field s7"><L t="API Key" id="key" open={openHelp} setOpen={setOpenHelp}/><input value={card.apiKey} onChange={ev=>up(card.id,{apiKey:ev.target.value})} placeholder="Bearer Token"/></div><div className="field s5"><L t="Modell" id="model" open={openHelp} setOpen={setOpenHelp}/><input list={`m_${card.id}`} value={card.model} onChange={ev=>up(card.id,{model:ev.target.value})} placeholder="z. B. gpt-oss:20b"/><datalist id={`m_${card.id}`}>{(modelOpts[card.id]||[]).map(m=><option key={m} value={m}/>)}</datalist></div></div>
          <div className="row"><div className="s3"><button onClick={()=>loadModels(card.id)} disabled={modelLoad[card.id]}>{modelLoad[card.id]?'Modelle laden...':'Modelle laden'}</button></div><div className="s3"><button onClick={()=>{const r=rt(card.id),el=r.start?((r.running?tick:(r.end||tick))-r.start)/1000:0;toast(`${card.name}: ${r.ok}/${r.sent} OK in ${dur(el)}`,'info')}}>Kurzstatus</button></div><div className="s6 small" style={{textAlign:'right'}}>Modelle in Liste: {i((modelOpts[card.id]||[]).length)}</div></div>
          <div className="row"><div className="field s6"><L t="System Prompt" id="sys" open={openHelp} setOpen={setOpenHelp}/><textarea value={card.systemPrompt} onChange={ev=>up(card.id,{systemPrompt:ev.target.value})}/></div><div className="field s6"><L t="User Prompt" id="prompt" open={openHelp} setOpen={setOpenHelp}/><textarea value={card.prompt} onChange={ev=>up(card.id,{prompt:ev.target.value})}/></div></div>
          <div className="row"><div className="field s2"><L t="Requests" id="total" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" value={card.totalRequests} onChange={ev=>up(card.id,{totalRequests:toNum(ev.target.value,0)})}/></div><div className="field s2"><L t="Max Parallel" id="par" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" value={card.maxParallel} onChange={ev=>up(card.id,{maxParallel:toNum(ev.target.value,0)})}/></div><div className="field s2"><L t="Intervall ms" id="delay" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" value={card.delayMs} onChange={ev=>up(card.id,{delayMs:toNum(ev.target.value,0)})}/></div><div className="field s2"><L t="Max Tokens" id="maxTok" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="1" value={card.maxTokens} onChange={ev=>up(card.id,{maxTokens:toNum(ev.target.value,128)})}/></div><div className="field s2"><L t="Temperatur" id="temp" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" max="2" step="0.1" value={card.temperature} onChange={ev=>up(card.id,{temperature:toNum(ev.target.value,.7)})}/></div><div className="field s2"><L t="Prioritaet" id="prio" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" max="100000" value={card.priority} onChange={ev=>up(card.id,{priority:toNum(ev.target.value,0)})}/></div></div>
          <div className="row"><div className="field s4"><L t="Streaming" id="stream" open={openHelp} setOpen={setOpenHelp}/><select value={card.stream?'1':'0'} onChange={ev=>up(card.id,{stream:ev.target.value==='1'})}><option value="0">Aus</option><option value="1">An (SSE)</option></select></div><div className="field s4"><L t="TLS Verifikation" id="tls" open={openHelp} setOpen={setOpenHelp}/><select value={card.sslVerify?'1':'0'} onChange={ev=>up(card.id,{sslVerify:ev.target.value==='1'})}><option value="1">Aktiv</option><option value="0">Deaktiviert (nur Test)</option></select></div><div className="field s4"><L t="Batch Marker" id="batch" open={openHelp} setOpen={setOpenHelp}/><input type="number" min="0" value={card.batch} onChange={ev=>up(card.id,{batch:toNum(ev.target.value,1)})}/></div></div>
          <div className="prog"><div style={{width:`${s?.prog||0}%`}}/></div>
          <div className="mgrid"><div className="m"><div className="v">{i(s?.sent||0)}</div><div className="k">Gesendet</div></div><div className="m"><div className="v">{i(s?.ok||0)}</div><div className="k">Erfolg</div></div><div className="m"><div className="v">{i(s?.fail||0)}</div><div className="k">Fehler</div></div><div className="m"><div className="v">{pc(s?.rate||0,1)}</div><div className="k">Erfolgsquote</div></div><div className="m"><div className="v">{ms(s?.al||0)}</div><div className="k">Durchschnitt</div></div><div className="m"><div className="v">{ms(s?.p95||0)}</div><div className="k">P95</div></div><div className="m"><div className="v">{n(s?.rps||0,2)}</div><div className="k">Req/s</div></div><div className="m"><div className="v">{n(s?.tps||0,1)}</div><div className="k">Tok/s</div></div></div>
          <div style={{display:'grid',gap:4}}><div className="small">Recent-Latenz (letzte {rc.length} Requests)</div><div style={{display:'flex',gap:1,alignItems:'flex-end',height:28,border:'1px solid var(--line)',borderRadius:7,padding:'2px',background:'#F7F7F7'}}>{rc.slice(-100).map((e,ix)=>{const h=Math.max(4,Math.min(100,((e.lat||0)/mx)*100));return <div key={ix} style={{flex:1,minWidth:1,height:`${h}%`,background:e.ok?'#01A982':'#FF4040',borderRadius:2,opacity:.85}}/>})}</div></div>
          {s?.errs?.length?<div><div className="small" style={{marginBottom:4}}>Fehler (neueste zuerst)</div><div className="errs">{s.errs.slice(0,10).map((e,ix)=><div key={`${e.ts}_${ix}`} className="err">{new Date(e.ts).toLocaleTimeString('de-DE',{hour12:false})} | {e.status?`HTTP ${e.status}`:'Transport'} | {String(e.msg||'')}</div>)}</div></div>:null}
        </div>
      </div>})}
    </div>

    <div className="panel main">
      <div className="sec">
        <div className="lab"><h2 className="st">Globales Dashboard</h2><Help id="dash" open={openHelp} setOpen={setOpenHelp}/></div>
        <div className="kpi"><div className="k"><div className="v">{i(g.cards)}</div><div className="l">Karten</div></div><div className="k"><div className="v">{i(g.running)}</div><div className="l">Aktiv</div></div><div className="k"><div className="v">{i(g.sent)}</div><div className="l">Requests</div></div><div className="k"><div className="v">{pc(g.rate,1)}</div><div className="l">Erfolgsquote</div></div><div className="k"><div className="v">{pc(g.errRate,1)}</div><div className="l">Fehlerquote</div></div><div className="k"><div className="v">{ms(g.avg)}</div><div className="l">Avg Latenz</div></div><div className="k"><div className="v">{ms(g.p95)}</div><div className="l">P95 Latenz</div></div><div className="k"><div className="v">{ms(g.ttfb)}</div><div className="l">TTFB avg</div></div><div className="k"><div className="v">{n(g.rps,2)}</div><div className="l">Req/s</div></div><div className="k"><div className="v">{n(g.tps,1)}</div><div className="l">Tok/s</div></div><div className="k"><div className="v">{i(g.inflight)}</div><div className="l">In-Flight</div></div><div className="k"><div className="v">{dur(g.el)}</div><div className="l">Laufzeit</div></div></div>
        <div className="small">Latenz-Histogramm (global)</div>
        <div style={{display:'grid',gap:3}}>{latHist.b.map((cnt,ix)=>{const st=(latHist.max/latHist.b.length)*ix,en=(latHist.max/latHist.b.length)*(ix+1),mx=Math.max(1,...latHist.b);return <div key={`lh_${ix}`} style={{display:'grid',gridTemplateColumns:'110px 1fr 56px',gap:7,alignItems:'center',fontSize:11}}><div style={{textAlign:'right',color:'var(--muted)'}}>{ms(st)} - {ms(en)}</div><div style={{height:18,background:'#F0F0F0',border:'1px solid var(--line)',borderRadius:6,overflow:'hidden'}}><div style={{height:'100%',width:`${(cnt/mx)*100}%`,background:'linear-gradient(90deg,rgba(1,169,130,.9),rgba(23,235,160,.9))'}}/></div><div style={{color:'var(--muted)'}}>{cnt}</div></div>})}</div>
        <div className="small">Completion-Token-Histogramm (letzte 900 Requests)</div>
        <div style={{display:'grid',gap:3}}>{tokHist.b.map((cnt,ix)=>{const st=Math.round((tokHist.max/tokHist.b.length)*ix),en=Math.round((tokHist.max/tokHist.b.length)*(ix+1)),mx=Math.max(1,...tokHist.b);return <div key={`th_${ix}`} style={{display:'grid',gridTemplateColumns:'110px 1fr 56px',gap:7,alignItems:'center',fontSize:11}}><div style={{textAlign:'right',color:'var(--muted)'}}>{st} - {en}</div><div style={{height:18,background:'#F0F0F0',border:'1px solid var(--line)',borderRadius:6,overflow:'hidden'}}><div style={{height:'100%',width:`${(cnt/mx)*100}%`,background:'linear-gradient(90deg,rgba(0,115,157,.9),rgba(80,170,200,.9))'}}/></div><div style={{color:'var(--muted)'}}>{cnt}</div></div>})}</div>
        <div className="small">Kartenvergleich (sortierbar)</div>
        <div className="tblw"><table className="tbl"><thead><tr>{[['name','Karte'],['sent','Sent'],['ok','OK'],['fail','Fail'],['rate','Rate'],['al','Avg'],['p95','P95'],['rps','Req/s'],['tps','Tok/s'],['ctps','Comp Tok/s'],['tt','TTFB'],['davg','Dispatch ms']].map(([k,l])=><th key={k} onClick={()=>setSort(p=>p.k===k?{k,asc:!p.asc}:{k,asc:true})}>{l}{sort.k===k?(sort.asc?' â':' â'):''}</th>)}</tr></thead><tbody>{sorted.map(s=><tr key={s.id}><td>{s.name}</td><td>{i(s.sent)}</td><td className="ok">{i(s.ok)}</td><td className="ko">{i(s.fail)}</td><td>{pc(s.rate,1)}</td><td>{ms(s.al)}</td><td>{ms(s.p95)}</td><td>{n(s.rps,2)}</td><td>{n(s.tps,1)}</td><td>{n(s.ctps,1)}</td><td>{ms(s.tt)}</td><td>{n(s.davg,1)}</td></tr>)}</tbody></table></div>
      </div>
      <div className="sec">
        <div className="lab"><h2 className="st">Request-Log</h2><Help id="log" open={openHelp} setOpen={setOpenHelp}/></div>
        <div style={{display:'flex',gap:8,justifyContent:'space-between',flexWrap:'wrap'}}><div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}} onClick={ev=>ev.stopPropagation()}><select value={logFilter} onChange={ev=>setLogFilter(ev.target.value)} style={{width:170}}><option value="all">Alle Eintraege</option><option value="ok">Nur Erfolg</option><option value="fail">Nur Fehler</option><option value="stream">Nur Streaming</option></select><label className="small" style={{display:'inline-flex',alignItems:'center',gap:6}}><input type="checkbox" checked={autoScroll} onChange={ev=>setAutoScroll(ev.target.checked)} style={{width:'auto'}}/>Auto-Scroll</label><span className="small">Anzahl: {i(fl.length)}</span></div></div>
        <div className="logw" ref={logRef}><table className="tbl"><thead><tr><th>Zeit</th><th>Karte</th><th>Modell</th><th>Status</th><th>Latenz</th><th>TTFB</th><th>P Tok</th><th>C Tok</th><th>Ges Tok</th><th>Tok/s</th><th>Prio</th><th>Batch</th><th>Seq</th><th>Preview</th></tr></thead><tbody>{fl.map(r=><tr key={r.id}><td>{new Date(r.ts).toLocaleTimeString('de-DE',{hour12:false})}</td><td>{r.card}</td><td>{r.model}</td><td className={r.ok?'ok':'ko'}>{r.ok?'OK':(r.status?`HTTP ${r.status}`:'ERR')}</td><td>{ms(r.lat)}</td><td>{ms(r.ttfb)}</td><td>{i(r.pTok)}</td><td>{i(r.cTok)}</td><td>{i(r.tTok)}</td><td>{n(r.tps,1)}</td><td>{i(r.prio)}</td><td>{i(r.batch)}</td><td>{i(r.seq)}</td><td style={{fontFamily:'Consolas,monospace'}}>{r.preview}</td></tr>)}</tbody></table></div>
      </div>
    </div>

    <div className="toastL">{toasts.map(t=><div key={t.id} className={`toast ${t.kind}`}>{t.msg}</div>)}</div>
  </div>
}
ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
</body>
</html>
